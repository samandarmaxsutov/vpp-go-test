{{ define "flow_settings" }}
<div class="container-fluid py-4">

    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h2><i class="bi bi-diagram-3-fill me-2"></i>IPFIX Flow Monitoring</h2>
            <p class="text-muted">Configure IPFIX export settings</p>
        </div>
    </div>

    <!-- Status Alert -->
    <div id="statusAlert" class="alert d-none" role="alert">
        <span id="statusMessage"></span>
    </div>

    <!-- Current Status -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-primary text-white">
            Current Status
        </div>
        <div class="card-body row">
            <div class="col-md-3">
                <small>Status</small><br>
                <span id="statusBadge" class="badge bg-secondary">Unknown</span>
            </div>
            <div class="col-md-3">
                <small>Collector</small><br>
                <span id="statusCollector">-</span>
            </div>
            <div class="col-md-3">
                <small>Source IP</small><br>
                <span id="statusSource">-</span>
            </div>
            <div class="col-md-3">
                <small>Template Interval</small><br>
                <span id="statusInterval">-</span>
            </div>

            <div class="mt-3">
                <button class="btn btn-sm btn-outline-primary" onclick="refreshStatus()">Refresh</button>
                <button class="btn btn-sm btn-outline-warning" onclick="flushIPFIX()">Flush</button>
            </div>
        </div>
    </div>

    <!-- Config Form -->
    <div class="card shadow-sm">
        <div class="card-header bg-light">Exporter Configuration</div>
        <div class="card-body">
            <form id="ipfixSettingsForm">

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label>Collector IP</label>
                        <input name="collector_address" class="form-control" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label>Collector Port</label>
                        <input name="collector_port" type="number" class="form-control" value="4739">
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label>Source IP</label>
                        <input name="source_address" class="form-control" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label>VRF ID</label>
                        <input name="vrf_id" type="number" class="form-control" value="0">
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label>Template Interval</label>
                        <input name="template_interval" type="number" class="form-control" value="20">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label>Path MTU</label>
                        <input name="path_mtu" type="number" class="form-control" value="1400">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label>
                            <input type="checkbox" name="udp_checksum"> UDP Checksum
                        </label>
                    </div>
                </div>

                <button class="btn btn-primary" type="submit">Save</button>
                <button class="btn btn-secondary" type="button" onclick="testConnection()">Test</button>
            </form>
        </div>
    </div>
</div>

<script>
let currentConfig = null;

// Load status
async function loadIpfixSettings() {
    const res = await fetch('/api/flow/ipfix');
    const status = await res.json();
    currentConfig = status;
    updateStatus(status);
    if (status.is_active) fillForm(status);
}

function updateStatus(s) {
    const badge = document.getElementById('statusBadge');
    if (s.is_active) {
        badge.className = 'badge bg-success';
        badge.innerText = 'Active';
        statusCollector.innerText = s.collector_address + ':' + s.collector_port;
        statusSource.innerText = s.source_address;
        statusInterval.innerText = s.template_interval + 's';
    } else {
        badge.className = 'badge bg-secondary';
        badge.innerText = 'Inactive';
    }
}

function fillForm(s) {
    const f = document.getElementById('ipfixSettingsForm');
    f.collector_address.value = s.collector_address || '';
    f.collector_port.value = s.collector_port || 4739;
    f.source_address.value = s.source_address || '';
    f.vrf_id.value = s.vrf_id || 0;
    f.template_interval.value = s.template_interval || 20;
    f.path_mtu.value = s.path_mtu || 1400;
    f.udp_checksum.checked = s.udp_checksum || false;
}

// Save
document.getElementById('ipfixSettingsForm').addEventListener('submit', async e => {
    e.preventDefault();
    const f = e.target;
    const data = {
        collector_address: f.collector_address.value,
        collector_port: +f.collector_port.value,
        source_address: f.source_address.value,
        vrf_id: +f.vrf_id.value,
        template_interval: +f.template_interval.value,
        path_mtu: +f.path_mtu.value,
        udp_checksum: f.udp_checksum.checked
    };

    const res = await fetch('/api/flow/ipfix', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    });

    showAlert(res.ok ? 'Saved' : 'Error', res.ok ? 'success' : 'danger');
    refreshStatus();
});

// Flush
async function flushIPFIX() {
    await fetch('/api/flow/ipfix/flush', { method: 'POST' });
    showAlert('Flushed', 'success');
}

// Test (UI-only)
function testConnection() {
    showAlert('Connection parameters look valid', 'info');
}

function refreshStatus() {
    loadIpfixSettings();
}

function showAlert(msg, type) {
    const a = document.getElementById('statusAlert');
    a.className = `alert alert-${type}`;
    a.classList.remove('d-none');
    statusMessage.innerText = msg;
    setTimeout(() => a.classList.add('d-none'), 3000);
}

document.addEventListener('DOMContentLoaded', loadIpfixSettings);
</script>
{{ end }}
