{{ define "ip_acl_list" }}
<div class="tab-pane fade show active" id="ip-acls">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h4 class="fw-bold text-dark mb-0"><i class="bi bi-shield-lock me-2"></i>Access Control Lists</h4>
            <small class="text-muted"> IPv4 ACL Manager</small>
        </div>
        <button class="btn btn-primary shadow-sm border-0" onclick="IP_ACL_LIST.openCreateModal()"
            style="background: linear-gradient(45deg, #0d6efd, #0a58ca);">
            <i class="bi bi-plus-lg me-1"></i> Yangi ACL yaratish
        </button>
    </div>

    <div id="ipAclListContainer">
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2 text-muted"> Ma'lumotlari yuklanmoqda...</p>
        </div>
    </div>
</div>

<!-- ACL Modal -->
<div class="modal fade" id="addACLModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title" id="aclModalTitle">ACL boshqarish</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addACLForm">
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <label class="form-label fw-bold small">ACL Nomi (Tag) <span
                                    class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="aclTagInput" name="tag"
                                placeholder="Masalan: Web_Traffic_Filter" required>
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="isStateful" name="is_stateful">
                                <label class="form-check-label fw-bold" for="isStateful">Stateful (Reflect)</label>
                            </div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label fw-bold">Vaqt Guruhi (Ixtiyoriy)</label>
                        <select class="form-select shadow-sm" id="acl_time_group_id" name="time_group_id">
                            <option value="">-- Vaqt cheklovi yo'q --</option>
                        </select>
                        <small class="text-muted d-block mt-2"><i class="bi bi-clock-history me-1"></i> Bu ACL faqatgina tanlangan vaqt oynasida avtomatik faol bo'ladi</small>
                    </div>

                    <div id="rulesContainer"></div>

                    <button type="button" class="btn btn-outline-secondary btn-sm mt-3"
                        onclick="IP_ACL_LIST.addRuleRow()">
                        <i class="bi bi-plus-circle me-1"></i> Yana qoida qo'shish
                    </button>
                </form>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Bekor qilish</button>
                <button type="button" class="btn btn-primary px-4" onclick="IP_ACL_LIST.saveACL()">
                    <i class="bi bi-check-lg me-1"></i> Saqlash
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Rule Modal -->
<div class="modal fade" id="editRuleModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Qoidani tahrirlash</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editRuleForm">
                    <input type="hidden" id="editAclIndex">
                    <input type="hidden" id="editRuleIndex">

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Action <span class="text-danger">*</span></label>
                            <select class="form-select" id="editAction" required>
                                <option value="permit">Permit</option>
                                <option value="deny">Deny</option>
                                <option value="permit_reflect">Permit + Reflect (Stateful)</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Protocol <span class="text-danger">*</span></label>
                            <select class="form-select" id="editProtocol" required>
                                <option value="tcp">TCP</option>
                                <option value="udp">UDP</option>
                                <option value="icmp">ICMP</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Source IP/Mask</label>
                            <input type="text" class="form-control" id="editSource" placeholder="0.0.0.0/0">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Destination IP/Mask</label>
                            <input type="text" class="form-control" id="editDestination" placeholder="0.0.0.0/0">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Source Port Range</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="editSrcPortFirst" min="0" max="65535"
                                    placeholder="0">
                                <span class="input-group-text">-</span>
                                <input type="number" class="form-control" id="editSrcPortLast" min="0" max="65535"
                                    placeholder="65535">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Destination Port Range</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="editDstPortFirst" min="0" max="65535"
                                    placeholder="0">
                                <span class="input-group-text">-</span>
                                <input type="number" class="form-control" id="editDstPortLast" min="0" max="65535"
                                    placeholder="65535">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Bekor qilish</button>
                <button type="button" class="btn btn-primary" onclick="IP_ACL_LIST.saveEditedRule()">
                    <i class="bi bi-check-lg me-1"></i> Saqlash
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    .anim-fade-in {
        animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .rule-row {
        transition: all 0.2s ease;
    }

    .rule-row:hover {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
</style>

<script>
    const IP_ACL_LIST = {
        data: { ipAcls: [] },

        async init() {
            await this.loadIpAcls();
        },

        async loadIpAcls() {
            try {
                const res = await fetch('/api/acl');
                if (!res.ok) throw new Error("Yuklab bo'lmadi");
                this.data.ipAcls = await res.json() || [];
                this.renderIpAcls();
            } catch (err) {
                document.getElementById('ipAclListContainer').innerHTML =
                    `<div class="alert alert-danger text-center">Xato: Backend bilan aloqa yo'q</div>`;
            }
        },

        renderIpAcls() {
            const container = document.getElementById('ipAclListContainer');
            if (this.data.ipAcls.length === 0) {
                container.innerHTML = `<div class="alert alert-info text-center py-4">Hozircha hech qanday ACL yaratilmagan.</div>`;
                return;
            }

            container.innerHTML = this.data.ipAcls.map(acl => `
                <div class="card shadow-sm border-0 mb-4 overflow-hidden anim-fade-in ${!acl.is_active ? 'opacity-75' : ''}">
                    <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center border-bottom">
                        <div>
                            <span class="badge bg-secondary me-2">Index: ${acl.acl_index}</span>
                            <span class="fw-bold text-primary fs-5">${acl.tag}</span>
                            ${acl.time_group_name !== '-' 
                                ? `<span class="badge bg-info ms-2" title="${acl.status_message}">
                                    <i class="bi bi-clock-history me-1"></i>${acl.time_group_name}
                                   </span>` 
                                : ''}
                            ${acl.is_active 
                                ? '<span class="badge bg-success ms-2"><i class="bi bi-check-circle me-1"></i>Faol</span>'
                                : '<span class="badge bg-secondary ms-2"><i class="bi bi-pause-circle me-1"></i>Nofaol</span>'}
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-success" onclick="IP_ACL_LIST.addRuleToExisting(${acl.acl_index})">
                                <i class="bi bi-plus-circle"></i> Qoida qo'shish
                            </button>
                            <button class="btn btn-sm btn-outline-primary" onclick="IP_ACL_LIST.openEditModal(${acl.acl_index})">
                                <i class="bi bi-pencil"></i> Tahrirlash
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="IP_ACL_LIST.deleteACL(${acl.acl_index})">
                                <i class="bi bi-trash"></i> O'chirish
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light small text-uppercase">
                                <tr>
                                    <th class="ps-3">#</th>
                                    <th>Action</th>
                                    <th>Source</th>
                                    <th>Destination</th>
                                    <th>Protocol</th>
                                    <th>Port Range</th>
                                    <th class="text-end pe-3">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${acl.rules.map((r, i) => `
                                    <tr>
                                        <td class="ps-3 text-muted">${i + 1}</td>
                                        <td>${this.renderActionBadge(r.is_permit)}</td>
                                        <td><code>${this.formatPrefix(r.src_prefix)}</code></td>
                                        <td><code>${this.formatPrefix(r.dst_prefix)}</code></td>
                                        <td><span class="badge bg-light text-dark border">${this.formatProto(r.proto)}</span></td>
                                        <td class="small">
                                            <span class="text-muted">Src:</span> ${r.srcport_or_icmptype_first || 0}-${r.srcport_or_icmptype_last || 65535} <br>
                                            <span class="text-muted">Dst:</span> ${r.dstport_or_icmpcode_first || 0}-${r.dstport_or_icmpcode_last || 65535}
                                        </td>
                                        <td class="text-end pe-3">
                                            <div class="btn-group">
                                                <button class="btn btn-link btn-sm text-primary p-0" onclick="IP_ACL_LIST.editRule(${acl.acl_index}, ${i})" title="Tahrirlash">
                                                    <i class="bi bi-pencil-square"></i>
                                                </button>
                                                <button class="btn btn-link btn-sm text-dark p-0 ms-2" onclick="IP_ACL_LIST.moveRule(${acl.acl_index}, ${i}, -1)" ${i === 0 ? 'disabled' : ''} title="Yuqoriga">
                                                    <i class="bi bi-caret-up-fill"></i>
                                                </button>
                                                <button class="btn btn-link btn-sm text-dark p-0 ms-2" onclick="IP_ACL_LIST.moveRule(${acl.acl_index}, ${i}, 1)" ${i === acl.rules.length - 1 ? 'disabled' : ''} title="Pastga">
                                                    <i class="bi bi-caret-down-fill"></i>
                                                </button>
                                                <button class="btn btn-link btn-sm text-danger p-0 ms-3" onclick="IP_ACL_LIST.deleteRule(${acl.acl_index}, ${i})" title="O'chirish">
                                                    <i class="bi bi-trash3"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `).join('');
        },

        renderActionBadge(isPermit) {
            if (isPermit === 0) return '<span class="badge bg-danger">DENY</span>';
            if (isPermit === 1) return '<span class="badge bg-success">PERMIT</span>';
            if (isPermit === 2) return '<span class="badge bg-info">PERMIT+REFLECT</span>';
            return '<span class="badge bg-secondary">UNKNOWN</span>';
        },

        formatPrefix(prefix) {
            if (!prefix) return '0.0.0.0/0';
            if (typeof prefix === 'string') return prefix;
            return `${prefix.address}/${prefix.len || 0}`;
        }
        ,

        mapToWebInput(rule) {
            let action = "deny";
            if (rule.is_permit === 1) action = "permit";
            if (rule.is_permit === 2) action = "permit_reflect";

            return {
                action: action,
                source: this.formatPrefix(rule.src_prefix),
                destination: this.formatPrefix(rule.dst_prefix),
                protocol: this.formatProto(rule.proto).toLowerCase(),
                src_port_first: parseInt(rule.srcport_or_icmptype_first ?? 0),
                src_port_last: parseInt(rule.srcport_or_icmptype_last ?? 65535),
                dst_port_first: parseInt(rule.dstport_or_icmpcode_first ?? 0),
                dst_port_last: parseInt(rule.dstport_or_icmpcode_last ?? 65535)
            };
        },

        addRuleRow(existingRule = null) {
            const container = document.getElementById('rulesContainer');
            const r = existingRule ? (existingRule.action ? existingRule : this.mapToWebInput(existingRule)) : null;

            const div = document.createElement('div');
            div.className = "row g-2 align-items-end mb-2 border p-2 rounded bg-white rule-row";
            div.innerHTML = `
                <div class="col-md-2">
                    <label class="small text-muted d-block">Action</label>
                    <select class="form-select form-select-sm" name="action[]">
                        <option value="permit" ${r?.action === 'permit' ? 'selected' : ''}>Permit</option>
                        <option value="deny" ${r?.action === 'deny' ? 'selected' : ''}>Deny</option>
                        <option value="permit_reflect" ${r?.action === 'permit_reflect' ? 'selected' : ''}>Permit+Reflect</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="small text-muted d-block">Source IP/Mask</label>
                    <input type="text" class="form-control form-control-sm" name="source[]" placeholder="0.0.0.0/0" value="${r?.source || '0.0.0.0/0'}">
                </div>
                <div class="col-md-2">
                    <label class="small text-muted d-block">Dest IP/Mask</label>
                    <input type="text" class="form-control form-control-sm" name="destination[]" placeholder="0.0.0.0/0" value="${r?.destination || '0.0.0.0/0'}">
                </div>
                <div class="col-md-1">
                    <label class="small text-muted d-block">Proto</label>
                    <select class="form-select form-select-sm" name="protocol[]">
                        <option value="tcp" ${r?.protocol === 'tcp' ? 'selected' : ''}>TCP</option>
                        <option value="udp" ${r?.protocol === 'udp' ? 'selected' : ''}>UDP</option>
                        <option value="icmp" ${r?.protocol === 'icmp' ? 'selected' : ''}>ICMP</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="small text-muted d-block">Src Port (Min-Max)</label>
                    <div class="input-group input-group-sm">
                        <input type="number" class="form-control" name="s_first[]" value="${r?.src_port_first ?? 0}" min="0" max="65535">
                        <input type="number" class="form-control" name="s_last[]" value="${r?.src_port_last ?? 65535}" min="0" max="65535">
                    </div>
                </div>
                <div class="col-md-2">
                    <label class="small text-muted d-block">Dst Port (Min-Max)</label>
                    <div class="input-group input-group-sm">
                        <input type="number" class="form-control" name="d_first[]" value="${r?.dst_port_first ?? 0}" min="0" max="65535">
                        <input type="number" class="form-control" name="d_last[]" value="${r?.dst_port_last ?? 65535}" min="0" max="65535">
                    </div>
                </div>
                <div class="col-md-1 text-end">
                    <button type="button" class="btn btn-sm btn-outline-danger border-0" onclick="this.closest('.rule-row').remove()">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>`;
            container.appendChild(div);
        },

        openCreateModal() {
            const form = document.getElementById('addACLForm');
            form.reset();
            delete form.dataset.aclIndex;
            document.getElementById('rulesContainer').innerHTML = '';
            this.addRuleRow();
            document.getElementById('aclModalTitle').innerText = "Yangi ACL yaratish";
            TimeGroupUtils.loadTimeGroupsIntoSelect('acl_time_group_id');
            new bootstrap.Modal(document.getElementById('addACLModal')).show();
        },

        openEditModal(aclIndex) {
            const acl = this.data.ipAcls.find(a => a.acl_index === aclIndex);
            if (!acl) return;

            const form = document.getElementById('addACLForm');
            form.reset();
            form.dataset.aclIndex = aclIndex;
            form.tag.value = acl.tag;

            document.getElementById('rulesContainer').innerHTML = '';
            acl.rules.forEach(rule => this.addRuleRow(rule));

            document.getElementById('aclModalTitle').innerText = `ACL Tahrirlash (ID: ${aclIndex})`;
            TimeGroupUtils.loadTimeGroupsIntoSelect('acl_time_group_id');
            new bootstrap.Modal(document.getElementById('addACLModal')).show();
        },

        async saveACL() {
            const form = document.getElementById('addACLForm');
            const aclIndex = form.dataset.aclIndex;
            const tagValue = document.getElementById('aclTagInput').value.trim();
            const timeGroupId = document.getElementById('acl_time_group_id').value;

            if (!tagValue) {
                alert("ACL nomini kiriting!");
                return;
            }

            const rows = document.querySelectorAll('.rule-row');
            const rules = Array.from(rows).map(row => ({
                action: row.querySelector('[name="action[]"]').value,
                source: row.querySelector('[name="source[]"]').value,
                destination: row.querySelector('[name="destination[]"]').value,
                protocol: row.querySelector('[name="protocol[]"]').value,
                src_port_first: parseInt(row.querySelector('[name="s_first[]"]').value) || 0,
                src_port_last: parseInt(row.querySelector('[name="s_last[]"]').value) || 65535,
                dst_port_first: parseInt(row.querySelector('[name="d_first[]"]').value) || 0,
                dst_port_last: parseInt(row.querySelector('[name="d_last[]"]').value) || 65535
            }));

            const payload = {
                tag: tagValue,
                is_stateful: document.getElementById('isStateful').checked,
                rules: rules
            };

            const url = aclIndex ? `/api/acl/${aclIndex}` : '/api/acl';
            const method = aclIndex ? 'PUT' : 'POST';

            try {
                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (res.ok) {
                    const result = await res.json();
                    const newAclIndex = aclIndex || result.acl_index;

                    // Assign time group if selected
                    if (timeGroupId) {
                        try {
                            await TimeGroupUtils.assignTimeGroupToRule(timeGroupId, 'ACL', String(newAclIndex));
                        } catch (err) {
                            console.error('Time group assignment failed:', err);
                            // Don't fail the entire save operation
                        }
                    }

                    bootstrap.Modal.getInstance(document.getElementById('addACLModal')).hide();
                    await this.loadIpAcls();
                } else {
                    const err = await res.json();
                    alert("Xato: " + (err.error || "Saqlab bo'lmadi"));
                }
            } catch (err) {
                alert("Server bilan bog'lanishda xato!");
            }
        },

        editRule(aclIndex, ruleIndex) {
            const acl = this.data.ipAcls.find(a => a.acl_index === aclIndex);
            if (!acl) return;

            const rule = acl.rules[ruleIndex];
            const webRule = this.mapToWebInput(rule);

            document.getElementById('editAclIndex').value = aclIndex;
            document.getElementById('editRuleIndex').value = ruleIndex;
            document.getElementById('editAction').value = webRule.action;
            document.getElementById('editProtocol').value = webRule.protocol;
            document.getElementById('editSource').value = webRule.source;
            document.getElementById('editDestination').value = webRule.destination;
            document.getElementById('editSrcPortFirst').value = webRule.src_port_first;
            document.getElementById('editSrcPortLast').value = webRule.src_port_last;
            document.getElementById('editDstPortFirst').value = webRule.dst_port_first;
            document.getElementById('editDstPortLast').value = webRule.dst_port_last;

            new bootstrap.Modal(document.getElementById('editRuleModal')).show();
        },

        async saveEditedRule() {
            const aclIndex = parseInt(document.getElementById('editAclIndex').value);
            const ruleIndex = parseInt(document.getElementById('editRuleIndex').value);

            const acl = this.data.ipAcls.find(a => a.acl_index === aclIndex);
            if (!acl) return;

            const updatedRule = {
                action: document.getElementById('editAction').value,
                source: document.getElementById('editSource').value,
                destination: document.getElementById('editDestination').value,
                protocol: document.getElementById('editProtocol').value,
                src_port_first: parseInt(document.getElementById('editSrcPortFirst').value) || 0,
                src_port_last: parseInt(document.getElementById('editSrcPortLast').value) || 65535,
                dst_port_first: parseInt(document.getElementById('editDstPortFirst').value) || 0,
                dst_port_last: parseInt(document.getElementById('editDstPortLast').value) || 65535
            };

            const allRules = acl.rules.map((r, i) => i === ruleIndex ? updatedRule : this.mapToWebInput(r));

            await this.executeSilentUpdate(aclIndex, acl.tag, allRules);
            bootstrap.Modal.getInstance(document.getElementById('editRuleModal')).hide();
        },

        async addRuleToExisting(aclIndex) {
            const acl = this.data.ipAcls.find(a => a.acl_index === aclIndex);
            if (!acl) return;

            const newRule = {
                action: "permit",
                source: "0.0.0.0/0",
                destination: "0.0.0.0/0",
                protocol: "tcp",
                src_port_first: 0,
                src_port_last: 65535,
                dst_port_first: 0,
                dst_port_last: 65535
            };

            const allRules = [...acl.rules.map(r => this.mapToWebInput(r)), newRule];
            await this.executeSilentUpdate(aclIndex, acl.tag, allRules);
        },

        async moveRule(aclIndex, ruleIdx, dir) {
            const acl = this.data.ipAcls.find(a => a.acl_index === aclIndex);
            const rules = [...acl.rules];
            const targetIdx = ruleIdx + dir;
            [rules[ruleIdx], rules[targetIdx]] = [rules[targetIdx], rules[ruleIdx]];

            await this.executeSilentUpdate(aclIndex, acl.tag, rules.map(r => this.mapToWebInput(r)));
        },

        async deleteRule(aclIndex, ruleIdx) {
            if (!confirm("Ushbu qoidani o'chirmoqchimisiz?")) return;
            const acl = this.data.ipAcls.find(a => a.acl_index === aclIndex);
            const newRules = acl.rules.filter((_, i) => i !== ruleIdx).map(r => this.mapToWebInput(r));
            await this.executeSilentUpdate(aclIndex, acl.tag, newRules);
        },

        async executeSilentUpdate(index, tag, webRules) {
            try {
                const res = await fetch(`/api/acl/${index}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tag: tag, rules: webRules, is_stateful: false })
                });
                if (res.ok) await this.loadIpAcls();
                else alert("Tartibni yangilab bo'lmadi");
            } catch (e) { console.error(e); }
        },

        async deleteACL(index) {
            if (!confirm("Diqqat! Ushbu ACL va uning barcha qoidalari butunlay o'chiriladi. Rozimisiz?")) return;
            try {
                await fetch(`/api/acl/${index}`, { method: 'DELETE' });
                await this.loadIpAcls();
            } catch (e) { alert("O'chirishda xato!"); }
        },

        formatProto(p) {
            const protos = { 1: 'ICMP', 6: 'TCP', 17: 'UDP', 58: 'ICMPv6' };
            if (typeof p === 'string') return p.toUpperCase();
            return protos[p] || p;
        }
    };

    document.addEventListener('DOMContentLoaded', () => IP_ACL_LIST.init());
</script>
{{ end }}