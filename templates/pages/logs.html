{{ template "base" . }}
{{ define "logs_page" }}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h4 class="fw-bold mb-0">Firewall Audit Logs</h4>
            <p class="text-muted small mb-0">Monitor va tahlil qiling tarmoq faoliyatini</p>
        </div>

        <div class="d-flex gap-2">
            <select class="form-select form-select-sm shadow-sm" id="pageSize" onchange="resetAndRender()" style="width: 130px;">
                <option value="10">10 talik</option>
                <option value="25" selected>25 talik</option>
                <option value="50">50 talik</option>
                <option value="100">100 talik</option>
            </select>
            
            <div class="btn-group shadow-sm bg-white p-1 rounded border">
                <button class="btn btn-sm btn-light filter-btn active" onclick="loadLogs('acl', this)">Firewall</button>
                <button class="btn btn-sm btn-light filter-btn" onclick="loadLogs('config', this)">Config</button>
                <button class="btn btn-sm btn-light filter-btn" onclick="loadLogs('auth', this)">Auth</button>
            </div>
        </div>
    </div>

    <div class="card shadow-sm border-0 mb-3">
        <div class="card-body p-3">
            <div class="row g-3">
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text bg-transparent border-end-0"><i class="bi bi-search"></i></span>
                        <input type="text" id="logSearch" class="form-control border-start-0" placeholder="Qidiruv (IP, Port, Harakat)..." onkeyup="handleSearch()">
                    </div>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="actionFilter" onchange="handleSearch()">
                        <option value="">Barcha Harakatlar</option>
                        <option value="DROP">DROP</option>
                        <option value="ACCEPT">ACCEPT</option>
                        <option value="REJECT">REJECT</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="protoFilter" onchange="handleSearch()">
                        <option value="">Barcha Protokollar</option>
                        <option value="TCP">TCP</option>
                        <option value="UDP">UDP</option>
                        <option value="ICMP">ICMP</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm border-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light text-muted small fw-bold text-uppercase">
                    <!-- Headers will be injected dynamically -->
                    <tr id="tableHeaderRow"></tr>
                </thead>
                <tbody id="logTableBody"></tbody>
            </table>
        </div>
        
        <div class="card-footer bg-white border-top py-3">
            <div class="d-flex justify-content-between align-items-center">
                <span class="small text-muted" id="logCounter">Jami: 0 yozuv</span>
                <nav>
                    <ul class="pagination pagination-sm mb-0" id="pagination"></ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- Detail Modal -->
<div class="modal fade" id="detailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Log Tafsilotlari</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>
</div>

<script>
let allData = [];
let filteredData = [];
let currentPage = 1;
let currentType = 'acl';

async function loadLogs(type = 'acl', element = null) {
    currentType = type;
    if (element) {
        document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active', 'btn-primary', 'text-white'));
        element.classList.add('active', 'btn-primary', 'text-white');
    }
    
    updateTableHeader(type);

    const tbody = document.getElementById('logTableBody');
    tbody.innerHTML = '<tr><td colspan="7" class="text-center py-5"><div class="spinner-border spinner-border-sm text-primary"></div></td></tr>';

    try {
        const res = await fetch(`/api/logs?type=${type}`);
        allData = await res.json();
        
        // Parse ACL logs
        if (type === 'acl') {
            allData = allData.map(log => parseACLLog(log));
        }
        
        filteredData = [...allData]; 
        currentPage = 1;
        renderTable();
    } catch (e) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center py-5 text-danger">Xatolik: Ma\'lumot yuklanmadi.</td></tr>';
    }
}

function updateTableHeader(type) {
    const tr = document.getElementById('tableHeaderRow');
    if (type === 'acl') {
        tr.innerHTML = `
            <th class="ps-3" style="width: 160px;">Vaqt</th>
            <th style="width: 90px;">Harakat</th>
            <th style="width: 80px;">Protokol</th>
            <th>Manba</th>
            <th>Manzil</th>
            <th style="width: 100px;">Packets</th>
            <th class="text-center pe-3" style="width: 80px;">Tafsilot</th>
        `;
    } else if (type === 'config') {
        tr.innerHTML = `
            <th class="ps-3" style="width: 160px;">Vaqt</th>
            <th style="width: 120px;">User</th>
            <th style="width: 120px;">IP</th>
            <th style="width: 100px;">Action</th>
            <th>Target</th>
            <th>Details</th>
            <th class="text-center pe-3" style="width: 80px;">View</th>
        `;
    } else if (type === 'auth') {
        tr.innerHTML = `
            <th class="ps-3" style="width: 160px;">Vaqt</th>
            <th style="width: 120px;">User</th>
            <th style="width: 120px;">IP</th>
            <th>Action</th>
            <th>Status</th>
            <th class="text-center pe-3" style="width: 80px;">View</th>
        `;
    } else {
        tr.innerHTML = `
            <th class="ps-3" style="width: 160px;">Vaqt</th>
            <th style="width: 100px;">Type</th>
            <th>Action</th>
            <th>Target</th>
            <th class="text-center pe-3">Status</th>
        `;
    }
}

function parseACLLog(log) {
    if (log.type !== 'ACL' && log.type !== 'acl') return log;
    
    const data = {};
    const target = log.target || '';
    
    // Parse key-value pairs from target
    target.split(' ').forEach(pair => {
        const [key, value] = pair.split('=');
        if (key && value) data[key] = value;
    });
    
    return {
        ...log,
        parsedData: data,
        protocol: getProtocolName(data.proto),
        sourceIP: data.src || 'N/A',
        destIP: data.dst || 'N/A',
        sourcePort: data.sport || '-',
        destPort: data.dport || '-',
        packetCount: data.count || '0',
        isIPv6: data.is_ip6 === '1'
    };
}

function getProtocolName(protoNum) {
    const protocols = { '6': 'TCP', '17': 'UDP', '1': 'ICMP' };
    return protocols[protoNum] || `Proto ${protoNum}`;
}

function renderTable() {
    const pageSize = parseInt(document.getElementById('pageSize').value);
    const tbody = document.getElementById('logTableBody');
    
    const start = (currentPage - 1) * pageSize;
    const end = start + pageSize;
    const items = filteredData.slice(start, end);

    if (items.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center py-5 text-muted">Ma\'lumot topilmadi.</td></tr>';
        renderPagination(0);
        return;
    }

    tbody.innerHTML = items.map(log => {
        if (currentType === 'acl') {
            return renderACLRow(log);
        } else if (currentType === 'config') {
            return renderConfigRow(log);
        } else if (currentType === 'auth') {
            return renderAuthRow(log);
        } else {
            return renderStandardRow(log);
        }
    }).join('');

    document.getElementById('logCounter').innerText = `Ko'rsatilyapti: ${start + 1}-${Math.min(end, filteredData.length)} / Jami: ${filteredData.length}`;
    renderPagination(filteredData.length);
}

function renderACLRow(log) {
    const actionBadge = getActionBadge(log.action);
    const protoBadge = getProtoBadge(log.protocol);
    
    return `
        <tr>
            <td class="ps-3 small text-muted font-monospace">${formatTimestamp(log.timestamp)}</td>
            <td>${actionBadge}</td>
            <td>${protoBadge}</td>
            <td>
                <div class="d-flex align-items-center gap-2">
                    <i class="bi bi-arrow-right-circle text-primary"></i>
                    <div>
                        <div class="fw-semibold small">${log.sourceIP}</div>
                        <div class="text-muted" style="font-size: 0.75rem;">Port: ${log.sourcePort}</div>
                    </div>
                </div>
            </td>
            <td>
                <div class="d-flex align-items-center gap-2">
                    <i class="bi bi-bullseye text-danger"></i>
                    <div>
                        <div class="fw-semibold small">${log.destIP}</div>
                        <div class="text-muted" style="font-size: 0.75rem;">Port: ${log.destPort}</div>
                    </div>
                </div>
            </td>
            <td><span class="badge bg-light text-dark border">${log.packetCount}</span></td>
            <td class="text-center pe-3">
                <button class="btn btn-sm btn-outline-primary" onclick='showDetails(${JSON.stringify(log).replace(/'/g, "&#39;")})'>
                    <i class="bi bi-info-circle"></i>
                </button>
            </td>
        </tr>
    `;
}

function renderConfigRow(log) {
    let detailsShort = log.details || '';
    if (detailsShort.length > 50) detailsShort = detailsShort.substring(0, 50) + '...';
    
    return `
        <tr>
            <td class="ps-3 small text-muted font-monospace">${formatTimestamp(log.timestamp)}</td>
            <td><span class="fw-bold text-dark">${log.user || 'System'}</span></td>
            <td><span class="small text-muted font-monospace">${log.ip || '-'}</span></td>
            <td>${getActionBadge(log.action)}</td>
            <td class="fw-semibold text-primary">${log.target}</td>
            <td class="small text-muted">${detailsShort}</td>
            <td class="text-center pe-3">
                <button class="btn btn-sm btn-outline-primary" onclick='showDetails(${JSON.stringify(log).replace(/'/g, "&#39;")})'>
                    <i class="bi bi-info-circle"></i>
                </button>
            </td>
        </tr>
    `;
}

function renderAuthRow(log) {
    const statusBadge = log.status === 'SUCCESS' 
        ? '<span class="badge bg-success-subtle text-success border border-success">SUCCESS</span>'
        : '<span class="badge bg-danger-subtle text-danger border border-danger">FAILED</span>';

    return `
        <tr>
            <td class="ps-3 small text-muted font-monospace">${formatTimestamp(log.timestamp)}</td>
            <td><span class="fw-bold text-dark">${log.user || 'System'}</span></td>
            <td><span class="small text-muted font-monospace">${log.ip || '-'}</span></td>
            <td class="fw-semibold">${log.action}</td>
            <td>${statusBadge}</td>
            <td class="text-center pe-3">
                <button class="btn btn-sm btn-outline-primary" onclick='showDetails(${JSON.stringify(log).replace(/'/g, "&#39;")})'><i class="bi bi-info-circle"></i></button>
            </td>
        </tr>
    `;
}

function renderStandardRow(log) {
    return `
        <tr>
            <td class="ps-3 small text-muted font-monospace">${formatTimestamp(log.timestamp)}</td>
            <td><span class="badge ${getBadgeClass(log.type || 'system')}">${(log.type || 'system').toUpperCase()}</span></td>
            <td class="fw-semibold">${log.action}</td>
            <td><code class="small">${log.target}</code></td>
            <td class="text-center pe-3">
                <span class="badge ${log.status === 'SUCCESS' ? 'bg-success' : 'bg-danger'}">${log.status}</span>
            </td>
        </tr>
    `;
}

function formatTimestamp(ts) {
    const date = new Date(ts);
    const today = new Date();
    const isToday = date.toDateString() === today.toDateString();
    
    if (isToday) {
        return date.toLocaleTimeString('uz-UZ', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    }
    return date.toLocaleString('uz-UZ', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
}

function getActionBadge(action) {
    const badges = {
        'DROP': '<span class="badge bg-danger-subtle text-danger border border-danger"><i class="bi bi-x-circle me-1"></i>DROP</span>',
        'ACCEPT': '<span class="badge bg-success-subtle text-success border border-success"><i class="bi bi-check-circle me-1"></i>ACCEPT</span>',
        'REJECT': '<span class="badge bg-warning-subtle text-warning border border-warning"><i class="bi bi-dash-circle me-1"></i>REJECT</span>'
    };
    // Add generic colors for other actions
    if (!badges[action]) {
        return `<span class="badge bg-secondary-subtle text-secondary border border-secondary">${action}</span>`;
    }
    return badges[action] || `<span class="badge bg-secondary">${action}</span>`;
}

function getProtoBadge(proto) {
    const badges = {
        'TCP': '<span class="badge bg-primary-subtle text-primary">TCP</span>',
        'UDP': '<span class="badge bg-info-subtle text-info">UDP</span>',
        'ICMP': '<span class="badge bg-warning-subtle text-warning">ICMP</span>'
    };
    return badges[proto] || `<span class="badge bg-secondary">${proto}</span>`;
}

function showDetails(log) {
    const modal = new bootstrap.Modal(document.getElementById('detailModal'));
    const body = document.getElementById('modalBody');
    
    if (currentType === 'acl') {
        body.innerHTML = `
            <div class="row g-3">
                <div class="col-md-6">
                    <div class="border rounded p-3">
                        <h6 class="text-muted mb-3"><i class="bi bi-arrow-right-circle text-primary me-2"></i>Manba Ma'lumotlari</h6>
                        <table class="table table-sm table-borderless mb-0">
                            <tr><td class="text-muted">IP Manzil:</td><td class="fw-semibold">${log.sourceIP}</td></tr>
                            <tr><td class="text-muted">Port:</td><td class="fw-semibold">${log.sourcePort}</td></tr>
                            <tr><td class="text-muted">IP Versiya:</td><td>${log.isIPv6 ? 'IPv6' : 'IPv4'}</td></tr>
                        </table>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="border rounded p-3">
                        <h6 class="text-muted mb-3"><i class="bi bi-bullseye text-danger me-2"></i>Manzil Ma'lumotlari</h6>
                        <table class="table table-sm table-borderless mb-0">
                            <tr><td class="text-muted">IP Manzil:</td><td class="fw-semibold">${log.destIP}</td></tr>
                            <tr><td class="text-muted">Port:</td><td class="fw-semibold">${log.destPort}</td></tr>
                            <tr><td class="text-muted">Protokol:</td><td>${getProtoBadge(log.protocol)}</td></tr>
                        </table>
                    </div>
                </div>
                <div class="col-12">
                    <div class="border rounded p-3 bg-light">
                        <h6 class="text-muted mb-3"><i class="bi bi-gear me-2"></i>Texnik Ma'lumotlar</h6>
                        <table class="table table-sm mb-0">
                            <tr><td class="text-muted">Harakat:</td><td>${getActionBadge(log.action)}</td></tr>
                            <tr><td class="text-muted">Vaqt:</td><td class="font-monospace">${log.timestamp}</td></tr>
                            <tr><td class="text-muted">Paketlar:</td><td>${log.packetCount}</td></tr>
                            <tr><td class="text-muted">Interface Index:</td><td>${log.parsedData.sw_if_index || 'N/A'}</td></tr>
                            <tr><td class="text-muted">ACL Index:</td><td>${log.parsedData.acl_index || 'N/A'}</td></tr>
                            <tr><td class="text-muted">Qoida Index:</td><td>${log.parsedData.rule_index || 'N/A'}</td></tr>
                        </table>
                    </div>
                </div>
            </div>
        `;
    } else if (currentType === 'config') {
        let formattedDetails = log.details;
        try {
            const json = JSON.parse(log.details);
            formattedDetails = `<pre class="bg-light p-2 border rounded small mb-0" style="max-height:300px; overflow:auto;">${JSON.stringify(json, null, 2)}</pre>`;
        } catch(e) {}

        body.innerHTML = `
            <div class="row g-3">
                <div class="col-md-6">
                    <div class="border rounded p-3 h-100">
                        <h6 class="text-muted mb-3"><i class="bi bi-person-badge me-2"></i>User Info</h6>
                        <table class="table table-sm table-borderless mb-0">
                            <tr><td class="text-muted">User:</td><td class="fw-bold">${log.user}</td></tr>
                            <tr><td class="text-muted">IP Address:</td><td class="font-monospace">${log.ip || 'N/A'}</td></tr>
                            <tr><td class="text-muted">Timestamp:</td><td class="font-monospace">${log.timestamp}</td></tr>
                        </table>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="border rounded p-3 h-100">
                        <h6 class="text-muted mb-3"><i class="bi bi-gear me-2"></i>Action Info</h6>
                        <table class="table table-sm table-borderless mb-0">
                            <tr><td class="text-muted">Action:</td><td>${getActionBadge(log.action)}</td></tr>
                            <tr><td class="text-muted">Target:</td><td class="fw-bold text-primary">${log.target}</td></tr>
                            <tr><td class="text-muted">Status:</td><td><span class="badge bg-success">SUCCESS</span></td></tr>
                        </table>
                    </div>
                </div>
                <div class="col-12">
                    <div class="border rounded p-3">
                        <h6 class="text-muted mb-2"><i class="bi bi-code-square me-2"></i>Configuration Details</h6>
                        ${formattedDetails}
                    </div>
                </div>
            </div>
        `;
    } else if (currentType === 'auth') {
        body.innerHTML = `
            <div class="row g-3">
                <div class="col-md-6">
                    <div class="border rounded p-3 h-100">
                        <h6 class="text-muted mb-3"><i class="bi bi-person-badge me-2"></i>User Info</h6>
                        <table class="table table-sm table-borderless mb-0">
                            <tr><td class="text-muted">User:</td><td class="fw-bold">${log.user}</td></tr>
                            <tr><td class="text-muted">IP Address:</td><td class="font-monospace">${log.ip || 'N/A'}</td></tr>
                            <tr><td class="text-muted">Timestamp:</td><td class="font-monospace">${log.timestamp}</td></tr>
                        </table>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="border rounded p-3 h-100">
                        <h6 class="text-muted mb-3"><i class="bi bi-shield-lock me-2"></i>Auth Details</h6>
                        <table class="table table-sm table-borderless mb-0">
                            <tr><td class="text-muted">Action:</td><td class="fw-bold">${log.action}</td></tr>
                            <tr><td class="text-muted">Status:</td><td><span class="badge ${log.status === 'SUCCESS' ? 'bg-success' : 'bg-danger'}">${log.status}</span></td></tr>
                        </table>
                    </div>
                </div>
            </div>
        `;
    } else {
        body.innerHTML = `<pre>${JSON.stringify(log, null, 2)}</pre>`;
    }
    
    modal.show();
}

function renderPagination(totalItems) {
    const pageSize = parseInt(document.getElementById('pageSize').value);
    const pageCount = Math.ceil(totalItems / pageSize);
    const pagination = document.getElementById('pagination');
    pagination.innerHTML = '';

    if (pageCount <= 1) return;

    const maxVisible = 7;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
    let endPage = Math.min(pageCount, startPage + maxVisible - 1);
    
    if (endPage - startPage < maxVisible - 1) {
        startPage = Math.max(1, endPage - maxVisible + 1);
    }

    if (currentPage > 1) {
        pagination.innerHTML += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(${currentPage - 1})">‹</a></li>`;
    }

    for (let i = startPage; i <= endPage; i++) {
        const li = document.createElement('li');
        li.className = `page-item ${currentPage === i ? 'active' : ''}`;
        li.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i})">${i}</a>`;
        pagination.appendChild(li);
    }

    if (currentPage < pageCount) {
        pagination.innerHTML += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(${currentPage + 1})">›</a></li>`;
    }
}

function changePage(page) {
    currentPage = page;
    renderTable();
}

function handleSearch() {
    const term = document.getElementById('logSearch').value.toLowerCase();
    const actionFilter = document.getElementById('actionFilter').value;
    const protoFilter = document.getElementById('protoFilter').value;
    
    filteredData = allData.filter(log => {
        const matchSearch = !term || 
            (log.sourceIP && log.sourceIP.toLowerCase().includes(term)) ||
            (log.destIP && log.destIP.toLowerCase().includes(term)) ||
            (log.sourcePort && log.sourcePort.includes(term)) ||
            (log.destPort && log.destPort.includes(term)) ||
            (log.action && log.action.toLowerCase().includes(term)) ||
            (log.target && log.target.toLowerCase().includes(term));
            
        const matchAction = !actionFilter || log.action === actionFilter;
        const matchProto = !protoFilter || log.protocol === protoFilter;
        
        return matchSearch && matchAction && matchProto;
    });
    
    currentPage = 1;
    renderTable();
}

function resetAndRender() {
    currentPage = 1;
    renderTable();
}

function getBadgeClass(type) {
    switch(type.toLowerCase()) {
        case 'acl': return 'bg-danger-subtle text-danger border border-danger';
        default: return 'bg-secondary-subtle text-secondary border border-secondary';
    }
}

document.addEventListener('DOMContentLoaded', () => loadLogs('acl'));
</script>

<style>
    .bg-purple-subtle { background-color: #f3e5f5; }
    .text-purple { color: #8e24aa; }
    .border-purple { border-color: #ce93d8 !important; }
    
    .btn-light.active { 
        background-color: #0d6efd !important; 
        border-color: #0d6efd !important; 
        color: white !important; 
    }
    
    .pagination .page-link { 
        border: none; 
        margin: 0 2px; 
        border-radius: 4px; 
        color: #666; 
    }
    
    .pagination .page-item.active .page-link { 
        background-color: #0d6efd; 
        color: white; 
    }
    
    table tbody tr:hover {
        background-color: #f8f9fa;
    }
    
    .badge {
        font-weight: 500;
        padding: 0.35em 0.65em;
    }
    
    code {
        background-color: #f8f9fa;
        padding: 0.2em 0.4em;
        border-radius: 3px;
        font-size: 0.875em;
    }
</style>
{{ end }}