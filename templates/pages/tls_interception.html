{{ template "base" . }}

{{ define "tls_interception_page" }}
<div class="container-fluid py-4">
  <!-- Header -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
        <div>
          <h3 class="mb-1"><i class="bi bi-shield-lock me-2"></i>Traffic Inspection</h3>
          <div class="ti-subtitle">Inspect and filter HTTP/HTTPS (and custom ports) traffic from selected interfaces</div>
        </div>

        <div class="d-flex align-items-center gap-2">
          <span id="dirtyBadge" class="badge text-bg-warning" style="display:none;">
            <i class="bi bi-exclamation-triangle me-1"></i>Unsaved changes
          </span>

          <button class="btn btn-outline-secondary" id="refreshBtn" onclick="refreshStatus(true)">
            <i class="bi bi-arrow-clockwise me-1"></i> Refresh
          </button>

          <button id="toggleBtn" class="btn btn-success" onclick="toggleInspection()">
            <i class="bi bi-play-circle me-1"></i> Enable
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Status Cards -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card border-0 shadow-sm">
        <div class="card-body text-center">
          <div id="statusIndicator" class="fs-1 mb-2">
            <i class="bi bi-circle-fill text-secondary"></i>
          </div>
          <h6 class="text-muted mb-0">Inspection Status</h6>
          <span id="statusText" class="fw-bold">Disabled</span>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card border-0 shadow-sm">
        <div class="card-body text-center">
          <div id="proxyIndicator" class="fs-1 mb-2">
            <i class="bi bi-circle-fill text-secondary"></i>
          </div>
          <h6 class="text-muted mb-0">Proxy Status</h6>
          <span id="proxyText" class="fw-bold">Stopped</span>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card border-0 shadow-sm">
        <div class="card-body text-center">
          <div class="fs-1 mb-2">
            <i class="bi bi-ethernet text-primary"></i>
          </div>
          <h6 class="text-muted mb-0">Active Interfaces</h6>
          <span id="interfaceCount" class="fw-bold">0</span>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card border-0 shadow-sm">
        <div class="card-body text-center">
          <div class="fs-1 mb-2">
            <i class="bi bi-plug text-info"></i>
          </div>
          <h6 class="text-muted mb-0">Active Ports</h6>
          <span id="activePortsText" class="fw-bold">None</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Main -->
  <div class="row">
    <!-- Left: Config -->
    <div class="col-lg-8">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-transparent ti-card-header">
          <div>
            <h5 class="mb-0"><i class="bi bi-gear me-2"></i>Configuration</h5>
            <div class="ti-inline-help">Changes apply to the running engine when you click <b>Apply changes</b>.</div>
          </div>

          <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary btn-sm" onclick="reloadConfig()">
              <i class="bi bi-arrow-counterclockwise me-1"></i> Reset
            </button>
            <button class="btn btn-primary btn-sm" id="applyBtn" onclick="saveConfig(false)" disabled>
              <i class="bi bi-check2-circle me-1"></i> Apply changes
            </button>
          </div>
        </div>

        <div class="card-body">
          <!-- Interfaces -->
          <div class="mb-4">
            <div class="ti-section-title">
              <i class="bi bi-diagram-3"></i>
              Interfaces to inspect
            </div>

            <div class="row g-2 align-items-end">
              <div class="col-md-9">
                <label class="form-label small mb-1">Add interface</label>
                <select class="form-select" id="ifaceSelect">
                  <option value="">Loading interfaces…</option>
                </select>
                <div class="ti-inline-help mt-1">
                  Dropdown shows <b>Tag</b> (if exists) + interface name + first IP. List excludes already selected interfaces.
                </div>
              </div>
              <div class="col-md-3">
                <button class="btn btn-outline-primary w-100" onclick="addSelectedInterface()">
                  <i class="bi bi-plus-circle me-1"></i> Add
                </button>
              </div>
            </div>

            <div class="mt-3">
              <div class="small text-muted mb-1">Selected interfaces (will be intercepted):</div>
              <div id="selectedInterfacesWrap"></div>
              <div id="noSelectedInterfaces" class="text-muted" style="display:none;">
                No interfaces selected yet.
              </div>
            </div>
          </div>

          <hr>

          <!-- Ports -->
          <div class="mb-4">
            <div class="ti-section-title">
              <i class="bi bi-funnel"></i>
              Ports to intercept
            </div>

            <div class="row g-2 align-items-end">
              <div class="col-md-6">
                <label class="form-label small mb-1">Add port</label>
                <input type="number" class="form-control" id="portInput" min="1" max="65535" placeholder="e.g. 80, 443, 8080, 5000">
              </div>
              <div class="col-md-3">
                <button class="btn btn-outline-primary w-100" onclick="addPortFromInput()">
                  <i class="bi bi-plus-circle me-1"></i> Add
                </button>
              </div>
              <div class="col-md-3">
                <div class="d-flex gap-2">
                  <button class="btn btn-outline-secondary w-100" onclick="quickAddPort(80)">HTTP</button>
                  <button class="btn btn-outline-secondary w-100" onclick="quickAddPort(443)">HTTPS</button>
                </div>
              </div>
            </div>

            <div class="mt-3">
              <div class="small text-muted mb-1">Selected ports (traffic will be redirected to mitmproxy):</div>
              <div id="selectedPortsWrap"></div>
              <div id="noSelectedPorts" class="text-muted" style="display:none;">
                No ports selected yet.
              </div>
              <div class="ti-inline-help mt-2">
                Tip: add any TCP ports you want (e.g. <code>8000</code>, <code>5000</code>, <code>8080</code>). Backend will update iptables REDIRECT rules live when you apply.
              </div>
            </div>
          </div>

          <hr>

          <!-- Excluded URLs -->
          <div class="mb-2">
            <div class="ti-section-title">
              <i class="bi bi-slash-circle"></i>
              Excluded URL patterns (do not write to logs)
            </div>

            <div class="row g-2 align-items-end">
              <div class="col-md-9">
                <label class="form-label small mb-1">Add pattern</label>
                <input type="text" class="form-control" id="excludeInput" placeholder="e.g. google-analytics.com, /metrics, healthcheck">
                <div class="ti-inline-help mt-1">
                  Use simple substrings (recommended). Backend matches these against the full URL (and/or host) and skips logging.
                </div>
              </div>
              <div class="col-md-3">
                <button class="btn btn-outline-primary w-100" onclick="addExcludeFromInput()">
                  <i class="bi bi-plus-circle me-1"></i> Add
                </button>
              </div>
            </div>

            <div class="mt-3">
              <div class="small text-muted mb-1">Active exclusions:</div>
              <div id="excludeWrap"></div>
              <div id="noExcludes" class="text-muted" style="display:none;">
                No exclusions configured.
              </div>
            </div>

            <div class="mt-3">
              <label class="form-label small mb-1">Bulk add (one per line)</label>
              <textarea class="form-control" id="excludeBulk" rows="4" placeholder="example.com&#10;/health&#10;/metrics"></textarea>
              <div class="d-flex justify-content-end mt-2">
                <button class="btn btn-outline-secondary btn-sm" onclick="addExcludesFromBulk()">
                  <i class="bi bi-list-check me-1"></i> Add lines
                </button>
              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- Optional: Logs -->
      <div class="card border-0 shadow-sm mt-3">
        <div class="card-header bg-transparent ti-card-header">
          <div>
            <h5 class="mb-0"><i class="bi bi-journal-text me-2"></i>Recent inspection logs</h5>
            <div class="ti-inline-help">Shows recent lines from the backend inspection log endpoint.</div>
          </div>
          <div class="d-flex gap-2">
            <select class="form-select form-select-sm" id="logsLines" style="width:auto;">
              <option value="50">Last 50</option>
              <option value="100">Last 100</option>
              <option value="200">Last 200</option>
            </select>
            <button class="btn btn-outline-secondary btn-sm" onclick="loadLogs()">
              <i class="bi bi-arrow-down-circle me-1"></i> Load
            </button>
          </div>
        </div>
        <div class="card-body">
          <div id="logsBox" class="ti-pre">Click “Load” to view logs…</div>
        </div>
      </div>

    </div>

    <!-- Right: Runtime / Info -->
    <div class="col-lg-4">

      <div class="card border-0 shadow-sm mb-3">
        <div class="card-header bg-transparent">
          <h5 class="mb-0"><i class="bi bi-check2-circle me-2"></i>Active inspection (runtime)</h5>
        </div>
        <div class="card-body">
          <div class="ti-kv mb-3">
            <div class="ti-muted">Enabled</div>
            <div id="rtEnabled">—</div>

            <div class="ti-muted">Proxy</div>
            <div id="rtProxy">—</div>

            <div class="ti-muted">Interfaces</div>
            <div id="rtIfaces">—</div>

            <div class="ti-muted">Ports</div>
            <div id="rtPorts">—</div>
          </div>

          <div id="runtimeWarning" class="alert alert-warning mb-0" style="display:none;">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <span id="runtimeWarningText"></span>
          </div>
        </div>
      </div>

      <div class="card border-0 shadow-sm mb-3">
        <div class="card-header bg-transparent">
          <h5 class="mb-0"><i class="bi bi-file-earmark-lock me-2"></i>CA certificate (fixed path)</h5>
        </div>
        <div class="card-body">
          <div class="ti-inline-help mb-2">
            Upload UI is removed. Project runs with sudo, so mitmproxy CA is expected under:
          </div>
          <div class="ti-pre mb-3">/root/.mitmproxy</div>

          <div class="ti-inline-help mb-2"><b>How to generate CA (recommended):</b></div>
          <div class="ti-pre mb-3">sudo -H mkdir -p /root/.mitmproxy
sudo -H mitmdump --set confdir=/root/.mitmproxy --listen-host 127.0.0.1 --listen-port 8080
# wait 2-3 seconds, then press Ctrl+C
# files will appear in /root/.mitmproxy (CA cert/key)</div>

          <div class="ti-inline-help mb-2"><b>If you already have a CA:</b></div>
          <div class="ti-inline-help">
            Place the expected PEM files in <code>/root/.mitmproxy</code> using the filenames your backend expects.
            (Example: mitmproxy default creates <code>mitmproxy-ca.pem</code> (key) and <code>mitmproxy-ca-cert.pem</code> (cert).)
          </div>
        </div>
      </div>

      <div class="card border-0 shadow-sm">
        <div class="card-header bg-transparent">
          <h5 class="mb-0"><i class="bi bi-lightbulb me-2"></i>Tips</h5>
        </div>
        <div class="card-body">
          <ul class="mb-0 small">
            <li>Choose interfaces with IP addresses (LAN-facing). TAP interfaces are hidden.</li>
            <li>Apply changes to update ABF/ACL and iptables live (no full engine restart).</li>
            <li>Use exclusions to reduce noise (analytics, health checks, metrics).</li>
          </ul>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
/**
 * Assumed backend endpoints (matching your existing routes):
 *  - GET  /api/interfaces                          -> []InterfaceInfo
 *  - GET  /api/tls-interception/config             -> {success, data:{lan_interfaces, intercept_ports, exclude_urls, ...}}
 *  - PUT  /api/tls-interception/config             -> apply to running engine (no restart)
 *  - GET  /api/tls-interception/simple-status      -> {success, data:{enabled, mitmproxy_running, attached_interfaces, active_ports, error_message}}
 *  - POST /api/tls-interception/enable|disable
 *  - GET  /api/tls-interception/logs?lines=N
 */

let currentStatus = {};
let currentConfig = {
  lan_interfaces: [],
  intercept_ports: [],
  exclude_urls: []
};

let availableInterfaces = [];
let isDirty = false;
let isRefreshing = false;

document.addEventListener('DOMContentLoaded', async function() {
  await reloadAll();
  // status auto-refresh only (does not overwrite your form if you’re editing)
  setInterval(() => refreshStatus(false), 5000);
});

async function reloadAll() {
  await Promise.allSettled([reloadConfig(), refreshStatus(true)]);
  await loadInterfaces();
  renderAll();
}

async function reloadConfig() {
  try {
    const result = await fetchJSON('/api/tls-interception/config');
    if (result && result.success) {
      currentConfig = normalizeConfig(result.data || {});
      setDirty(false);
      // we re-render after interfaces load too; but safe now:
      renderSelectedInterfaces();
      renderSelectedPorts();
      renderExcludes();
      fillIfaceDropdown();
    } else {
      showToast('Failed to load config', 'danger');
    }
  } catch (e) {
    console.error(e);
    showToast('Failed to load config: ' + e.message, 'danger');
  }
}

async function loadInterfaces() {
  try {
    const data = await fetchJSON('/api/interfaces');
    // /api/interfaces may return raw [] or {success,data:[]}
    let list = Array.isArray(data) ? data : (data && data.data ? data.data : []);
    availableInterfaces = (list || []).filter(iface =>
      iface &&
      iface.name &&
      iface.name !== 'local0' &&
      !String(iface.name).startsWith('tap') &&
      iface.ip_addresses &&
      iface.ip_addresses.length > 0
    );
    fillIfaceDropdown();
    renderSelectedInterfaces();
  } catch (e) {
    console.error(e);
    availableInterfaces = [];
    fillIfaceDropdown();
  }
}

async function refreshStatus(force) {
  if (isRefreshing && !force) return;
  isRefreshing = true;
  try {
    const result = await fetchJSON('/api/tls-interception/simple-status');
    if (result && result.success) {
      currentStatus = result.data || {};
      updateStatusUI(currentStatus);
    }
  } catch (e) {
    // ignore noisy refresh errors
  } finally {
    isRefreshing = false;
  }
}

function normalizeConfig(cfg) {
  const out = {...cfg};
  // ensure arrays
  out.lan_interfaces = Array.isArray(out.lan_interfaces) ? out.lan_interfaces : (out.lan_interface ? [out.lan_interface] : []);
  out.intercept_ports = Array.isArray(out.intercept_ports) ? out.intercept_ports : derivePortsFromLegacy(out);
  out.exclude_urls = Array.isArray(out.exclude_urls) ? out.exclude_urls : [];
  // de-dupe
  out.lan_interfaces = dedupeStrings(out.lan_interfaces);
  out.intercept_ports = dedupePorts(out.intercept_ports);
  out.exclude_urls = dedupeStrings(out.exclude_urls);
  return out;
}

function derivePortsFromLegacy(cfg) {
  // Backwards compatibility if backend still returns intercept_http/intercept_https
  const ports = [];
  if (cfg.intercept_http !== false) ports.push(80);
  if (cfg.intercept_https !== false) ports.push(443);
  return ports;
}

function renderAll() {
  fillIfaceDropdown();
  renderSelectedInterfaces();
  renderSelectedPorts();
  renderExcludes();
  updateStatusUI(currentStatus);
}

function fillIfaceDropdown() {
  const sel = document.getElementById('ifaceSelect');
  if (!sel) return;

  const selected = new Set((currentConfig.lan_interfaces || []).map(String));
  const options = availableInterfaces
    .filter(iface => !selected.has(String(iface.name)))
    .map(iface => {
      const displayName = iface.tag ? `${iface.tag} (${iface.name})` : iface.name;
      const ip = (iface.ip_addresses && iface.ip_addresses[0]) ? iface.ip_addresses[0] : '';
      return { value: iface.name, label: `${displayName} — ${ip}` };
    });

  sel.innerHTML = '';
  const placeholder = document.createElement('option');
  placeholder.value = '';
  placeholder.textContent = options.length ? 'Select interface…' : 'No more interfaces available';
  sel.appendChild(placeholder);

  for (const opt of options) {
    const o = document.createElement('option');
    o.value = opt.value;
    o.textContent = opt.label;
    sel.appendChild(o);
  }
}

function renderSelectedInterfaces() {
  const wrap = document.getElementById('selectedInterfacesWrap');
  const empty = document.getElementById('noSelectedInterfaces');
  if (!wrap || !empty) return;

  const selected = currentConfig.lan_interfaces || [];
  wrap.innerHTML = '';

  if (selected.length === 0) {
    empty.style.display = 'block';
    return;
  }
  empty.style.display = 'none';

  for (const ifaceName of selected) {
    const iface = availableInterfaces.find(i => String(i.name) === String(ifaceName));
    const displayName = iface ? (iface.tag ? `${iface.tag} (${iface.name})` : iface.name) : ifaceName;
    const ip = iface && iface.ip_addresses && iface.ip_addresses[0] ? iface.ip_addresses[0] : '';
    const subnet = ip ? approxSubnet(ip) : '';

    const pill = document.createElement('span');
    pill.className = 'ti-pill';
    pill.innerHTML = `
      <i class="bi bi-ethernet text-primary"></i>
      <span>
        <b>${escapeHtml(displayName)}</b>
        ${ip ? `<span class="ti-muted">— ${escapeHtml(ip)}</span>` : ''}
        ${subnet ? `<span class="ti-muted ms-1">(subnet ${escapeHtml(subnet)})</span>` : ''}
      </span>
      <button type="button" class="btn-close ms-2" aria-label="Remove"></button>
    `;
    pill.querySelector('.btn-close').addEventListener('click', () => {
      removeInterface(ifaceName);
    });
    wrap.appendChild(pill);
  }
}

function approxSubnet(ipWithMask) {
  // UI-only preview (backend does the real subnet logic)
  try {
    const [ip, mask] = String(ipWithMask).split('/');
    const parts = ip.split('.');
    if (parts.length !== 4) return '';
    const m = mask || '24';
    return `${parts[0]}.${parts[1]}.${parts[2]}.0/${m}`;
  } catch {
    return '';
  }
}

function addSelectedInterface() {
  const sel = document.getElementById('ifaceSelect');
  const val = sel ? sel.value : '';
  if (!val) {
    showToast('Select an interface first', 'warning');
    return;
  }
  if (!currentConfig.lan_interfaces) currentConfig.lan_interfaces = [];
  if (currentConfig.lan_interfaces.includes(val)) return;

  currentConfig.lan_interfaces.push(val);
  currentConfig.lan_interfaces = dedupeStrings(currentConfig.lan_interfaces);
  setDirty(true);

  // update UI
  sel.value = '';
  fillIfaceDropdown();
  renderSelectedInterfaces();
}

function removeInterface(name) {
  currentConfig.lan_interfaces = (currentConfig.lan_interfaces || []).filter(x => String(x) !== String(name));
  setDirty(true);
  fillIfaceDropdown();
  renderSelectedInterfaces();
}

function renderSelectedPorts() {
  const wrap = document.getElementById('selectedPortsWrap');
  const empty = document.getElementById('noSelectedPorts');
  if (!wrap || !empty) return;

  const ports = (currentConfig.intercept_ports || []).slice().sort((a,b)=>a-b);
  wrap.innerHTML = '';

  if (ports.length === 0) {
    empty.style.display = 'block';
    return;
  }
  empty.style.display = 'none';

  for (const p of ports) {
    const label = (p === 80) ? '80 (HTTP)' : (p === 443) ? '443 (HTTPS)' : String(p);
    const pill = document.createElement('span');
    pill.className = 'ti-pill';
    pill.innerHTML = `
      <i class="bi bi-plug text-info"></i>
      <span><b>${escapeHtml(label)}</b></span>
      <button type="button" class="btn-close ms-2" aria-label="Remove"></button>
    `;
    pill.querySelector('.btn-close').addEventListener('click', () => {
      removePort(p);
    });
    wrap.appendChild(pill);
  }
}

function quickAddPort(p) {
  addPort(p);
}

function addPortFromInput() {
  const input = document.getElementById('portInput');
  const val = input ? input.value : '';
  const p = parseInt(val, 10);
  if (!Number.isFinite(p)) {
    showToast('Enter a valid port number', 'warning');
    return;
  }
  if (p < 1 || p > 65535) {
    showToast('Port must be between 1 and 65535', 'warning');
    return;
  }
  addPort(p);
  if (input) input.value = '';
}

function addPort(p) {
  if (!currentConfig.intercept_ports) currentConfig.intercept_ports = [];
  if (currentConfig.intercept_ports.includes(p)) return;
  currentConfig.intercept_ports.push(p);
  currentConfig.intercept_ports = dedupePorts(currentConfig.intercept_ports);
  setDirty(true);
  renderSelectedPorts();
}

function removePort(p) {
  currentConfig.intercept_ports = (currentConfig.intercept_ports || []).filter(x => Number(x) !== Number(p));
  setDirty(true);
  renderSelectedPorts();
}

function renderExcludes() {
  const wrap = document.getElementById('excludeWrap');
  const empty = document.getElementById('noExcludes');
  if (!wrap || !empty) return;

  const list = currentConfig.exclude_urls || [];
  wrap.innerHTML = '';

  if (list.length === 0) {
    empty.style.display = 'block';
    return;
  }
  empty.style.display = 'none';

  for (const s of list) {
    const pill = document.createElement('span');
    pill.className = 'ti-pill';
    pill.innerHTML = `
      <i class="bi bi-slash-circle text-danger"></i>
      <span><b>${escapeHtml(s)}</b></span>
      <button type="button" class="btn-close ms-2" aria-label="Remove"></button>
    `;
    pill.querySelector('.btn-close').addEventListener('click', () => {
      removeExclude(s);
    });
    wrap.appendChild(pill);
  }
}

function addExcludeFromInput() {
  const input = document.getElementById('excludeInput');
  const val = input ? input.value.trim() : '';
  if (!val) {
    showToast('Enter a pattern first', 'warning');
    return;
  }
  addExclude(val);
  if (input) input.value = '';
}

function addExcludesFromBulk() {
  const ta = document.getElementById('excludeBulk');
  const raw = ta ? ta.value : '';
  const lines = raw.split('\n').map(x => x.trim()).filter(Boolean);
  if (lines.length === 0) {
    showToast('No lines to add', 'warning');
    return;
  }
  let added = 0;
  for (const line of lines) {
    if (addExclude(line, true)) added++;
  }
  if (ta) ta.value = '';
  if (added > 0) {
    showToast(`Added ${added} exclusion(s)`, 'success');
  }
  renderExcludes();
}

function addExclude(s, silent=false) {
  if (!currentConfig.exclude_urls) currentConfig.exclude_urls = [];
  if (currentConfig.exclude_urls.includes(s)) return false;
  currentConfig.exclude_urls.push(s);
  currentConfig.exclude_urls = dedupeStrings(currentConfig.exclude_urls);
  setDirty(true);
  if (!silent) renderExcludes();
  return true;
}

function removeExclude(s) {
  currentConfig.exclude_urls = (currentConfig.exclude_urls || []).filter(x => String(x) !== String(s));
  setDirty(true);
  renderExcludes();
}

function setDirty(flag) {
  isDirty = !!flag;
  const badge = document.getElementById('dirtyBadge');
  const applyBtn = document.getElementById('applyBtn');
  if (badge) badge.style.display = isDirty ? 'inline-block' : 'none';
  if (applyBtn) applyBtn.disabled = !isDirty;
}

async function saveConfig(isAutoForEnable) {
  // Validate
  const ifaces = currentConfig.lan_interfaces || [];
  if (ifaces.length === 0) {
    showToast('Please select at least one interface to inspect', 'warning');
    return false;
  }
  const ports = currentConfig.intercept_ports || [];
  if (ports.length === 0) {
    showToast('Please add at least one port to intercept', 'warning');
    return false;
  }

  // Apply button state
  const applyBtn = document.getElementById('applyBtn');
  const oldHtml = applyBtn ? applyBtn.innerHTML : '';
  if (applyBtn) {
    applyBtn.disabled = true;
    applyBtn.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span>Applying…`;
  }

  try {
    const payload = {
      ...currentConfig,
      lan_interfaces: dedupeStrings(currentConfig.lan_interfaces || []),
      intercept_ports: dedupePorts(currentConfig.intercept_ports || []),
      exclude_urls: dedupeStrings(currentConfig.exclude_urls || [])
    };

    const res = await fetchJSON('/api/tls-interception/config', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (res && res.success) {
      currentConfig = normalizeConfig(res.data || payload);
      setDirty(false);
      showToast('Configuration applied', 'success');
      // Status refresh to reflect applied ports/interfaces
      await refreshStatus(true);
      // Dropdown may change now
      fillIfaceDropdown();
      renderSelectedInterfaces();
      renderSelectedPorts();
      renderExcludes();
      return true;
    } else {
      showToast('Failed to apply: ' + (res && res.error ? res.error : 'unknown error'), 'danger');
      return false;
    }
  } catch (e) {
    showToast('Failed to apply: ' + e.message, 'danger');
    return false;
  } finally {
    if (applyBtn) {
      applyBtn.innerHTML = oldHtml;
      applyBtn.disabled = !isDirty;
    }
  }
}

async function toggleInspection() {
  const isEnabled = !!currentStatus.enabled;
  const endpoint = isEnabled ? '/api/tls-interception/disable' : '/api/tls-interception/enable';
  const toggleBtn = document.getElementById('toggleBtn');

  // If enabling and there are unsaved changes, apply first
  if (!isEnabled && isDirty) {
    const ok = await saveConfig(true);
    if (!ok) return;
  }

  // If enabling and config seems empty, force validation
  if (!isEnabled && !isDirty) {
    // still validate config before enabling (helps prevent confusing enable failures)
    const ifaces = currentConfig.lan_interfaces || [];
    const ports = currentConfig.intercept_ports || [];
    if (ifaces.length === 0) {
      showToast('Please select at least one interface to inspect', 'warning');
      return;
    }
    if (ports.length === 0) {
      showToast('Please add at least one port to intercept', 'warning');
      return;
    }
  }

  const old = toggleBtn ? toggleBtn.innerHTML : '';
  if (toggleBtn) {
    toggleBtn.disabled = true;
    toggleBtn.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span>${isEnabled ? 'Disabling…' : 'Enabling…'}`;
  }

  try {
    const res = await fetchJSON(endpoint, { method: 'POST' });
    if (res && res.success) {
      showToast(isEnabled ? 'Inspection disabled' : 'Inspection enabled', 'success');
      await refreshStatus(true);
    } else {
      showToast('Operation failed: ' + (res && res.error ? res.error : 'unknown error'), 'danger');
    }
  } catch (e) {
    showToast('Operation failed: ' + e.message, 'danger');
  } finally {
    if (toggleBtn) {
      toggleBtn.disabled = false;
      toggleBtn.innerHTML = old || (isEnabled ? '<i class="bi bi-play-circle me-1"></i> Enable' : '<i class="bi bi-stop-circle me-1"></i> Disable');
    }
  }
}

function updateStatusUI(status) {
  // top cards
  const statusIndicator = document.getElementById('statusIndicator');
  const statusText = document.getElementById('statusText');
  const proxyIndicator = document.getElementById('proxyIndicator');
  const proxyText = document.getElementById('proxyText');
  const interfaceCount = document.getElementById('interfaceCount');
  const activePortsText = document.getElementById('activePortsText');
  const toggleBtn = document.getElementById('toggleBtn');

  const enabled = !!status.enabled;
  const proxy = !!status.mitmproxy_running;
  const ports = Array.isArray(status.active_ports) ? status.active_ports : [];
  const ifaces = Array.isArray(status.attached_interfaces) ? status.attached_interfaces : [];

  if (enabled) {
    if (statusIndicator) statusIndicator.innerHTML = '<i class="bi bi-circle-fill text-success"></i>';
    if (statusText) statusText.textContent = 'Active';
    if (toggleBtn) {
      toggleBtn.className = 'btn btn-danger';
      toggleBtn.innerHTML = '<i class="bi bi-stop-circle me-1"></i> Disable';
    }
  } else {
    if (statusIndicator) statusIndicator.innerHTML = '<i class="bi bi-circle-fill text-secondary"></i>';
    if (statusText) statusText.textContent = 'Disabled';
    if (toggleBtn) {
      toggleBtn.className = 'btn btn-success';
      toggleBtn.innerHTML = '<i class="bi bi-play-circle me-1"></i> Enable';
    }
  }

  if (proxy) {
    if (proxyIndicator) proxyIndicator.innerHTML = '<i class="bi bi-circle-fill text-success"></i>';
    if (proxyText) proxyText.textContent = 'Running';
  } else {
    if (proxyIndicator) proxyIndicator.innerHTML = '<i class="bi bi-circle-fill text-danger"></i>';
    if (proxyText) proxyText.textContent = 'Stopped';
  }

  if (activePortsText) {
    activePortsText.textContent = ports.length ? ports.join(', ') : 'None';
  }
  if (interfaceCount) interfaceCount.textContent = String(ifaces.length);

  // right runtime panel
  const rtEnabled = document.getElementById('rtEnabled');
  const rtProxy = document.getElementById('rtProxy');
  const rtIfaces = document.getElementById('rtIfaces');
  const rtPorts = document.getElementById('rtPorts');

  if (rtEnabled) rtEnabled.innerHTML = enabled ? '<span class="badge text-bg-success">Yes</span>' : '<span class="badge text-bg-secondary">No</span>';
  if (rtProxy) rtProxy.innerHTML = proxy ? '<span class="badge text-bg-success">Running</span>' : '<span class="badge text-bg-danger">Stopped</span>';
  if (rtIfaces) rtIfaces.textContent = ifaces.length ? ifaces.join(', ') : '—';
  if (rtPorts) rtPorts.textContent = ports.length ? ports.join(', ') : '—';

  // warnings
  const warn = document.getElementById('runtimeWarning');
  const warnText = document.getElementById('runtimeWarningText');

  let msg = '';
  if (enabled && !proxy) msg = 'Proxy is not running. Traffic may not be inspected.';
  if (status.error_message) msg = status.error_message;

  if (warn && warnText) {
    if (msg) {
      warnText.textContent = msg;
      warn.style.display = 'block';
    } else {
      warn.style.display = 'none';
    }
  }
}

async function loadLogs() {
  const box = document.getElementById('logsBox');
  const linesSel = document.getElementById('logsLines');
  const lines = linesSel ? parseInt(linesSel.value, 10) : 50;

  if (box) box.textContent = 'Loading…';
  try {
    const res = await fetchJSON(`/api/tls-interception/logs?lines=${encodeURIComponent(lines)}`);
    if (res && res.success) {
      const arr = res.data || [];
      box.textContent = Array.isArray(arr) ? arr.join('\n') : String(arr);
    } else {
      box.textContent = 'Failed to load logs';
    }
  } catch (e) {
    box.textContent = 'Failed to load logs: ' + e.message;
  }
}

// helpers
async function fetchJSON(url, options) {
  const r = await fetch(url, options);
  const text = await r.text();
  try {
    return JSON.parse(text);
  } catch {
    // sometimes endpoints return plain string; wrap
    return text;
  }
}

function dedupeStrings(arr) {
  const out = [];
  const seen = new Set();
  for (const x of (arr || [])) {
    const s = String(x).trim();
    if (!s) continue;
    if (seen.has(s)) continue;
    seen.add(s);
    out.push(s);
  }
  return out;
}

function dedupePorts(arr) {
  const out = [];
  const seen = new Set();
  for (const x of (arr || [])) {
    const n = Number(x);
    if (!Number.isFinite(n)) continue;
    const p = Math.floor(n);
    if (p < 1 || p > 65535) continue;
    if (seen.has(p)) continue;
    seen.add(p);
    out.push(p);
  }
  return out;
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text == null ? '' : String(text);
  return div.innerHTML;
}

function showToast(message, type) {
  const toast = document.createElement('div');
  toast.className = `alert alert-${type} position-fixed bottom-0 end-0 m-3 shadow-sm`;
  toast.style.zIndex = '9999';
  toast.style.maxWidth = '420px';
  toast.innerHTML = `<div class="d-flex align-items-start gap-2">
    <div>${escapeHtml(message)}</div>
    <button type="button" class="btn-close ms-auto" aria-label="Close"></button>
  </div>`;
  toast.querySelector('.btn-close').addEventListener('click', ()=>toast.remove());
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 4000);
}
</script>
{{ end }}
