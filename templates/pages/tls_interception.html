{{ template "base" . }}

{{ define "tls_interception_page" }}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h3 class="mb-1"><i class="bi bi-shield-lock me-2"></i>Traffic Inspection</h3>
                    <p class="text-muted mb-0">Inspect and filter HTTP/HTTPS traffic from selected interfaces</p>
                </div>
                <div>
                    <button class="btn btn-outline-secondary me-2" onclick="refreshStatus()">
                        <i class="bi bi-arrow-clockwise me-1"></i> Refresh
                    </button>
                    <button id="toggleBtn" class="btn btn-success" onclick="toggleInspection()">
                        <i class="bi bi-play-circle me-1"></i> Enable
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Cards - Simplified -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <div id="statusIndicator" class="fs-1 mb-2">
                        <i class="bi bi-circle-fill text-secondary"></i>
                    </div>
                    <h6 class="text-muted mb-0">Inspection Status</h6>
                    <span id="statusText" class="fw-bold">Disabled</span>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <div id="systemIndicator" class="fs-1 mb-2">
                        <i class="bi bi-circle-fill text-secondary"></i>
                    </div>
                    <h6 class="text-muted mb-0">System Ready</h6>
                    <span id="systemText" class="fw-bold">Not Configured</span>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <div class="fs-1 mb-2">
                        <i class="bi bi-ethernet text-primary"></i>
                    </div>
                    <h6 class="text-muted mb-0">Active Interfaces</h6>
                    <span id="interfaceCount" class="fw-bold">0</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Configuration -->
    <div class="row">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-transparent">
                    <h5 class="mb-0"><i class="bi bi-gear me-2"></i>Configuration</h5>
                </div>
                <div class="card-body">
                    <!-- Interface Selection -->
                    <h6 class="text-primary mb-3"><i class="bi bi-diagram-3 me-1"></i> Select Interface to Inspect</h6>
                    <div class="row g-3 mb-4">
                        <div class="col-12">
                            <div id="interfaceList" class="d-flex flex-wrap gap-2">
                                <div class="text-muted">Loading interfaces...</div>
                            </div>
                        </div>
                    </div>

                    <!-- Traffic Settings -->
                    <h6 class="text-primary mb-3"><i class="bi bi-funnel me-1"></i> Traffic Type</h6>
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="interceptHTTP" checked>
                                <label class="form-check-label" for="interceptHTTP">
                                    <i class="bi bi-globe me-1"></i> HTTP Traffic (Port 80)
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="interceptHTTPS" checked>
                                <label class="form-check-label" for="interceptHTTPS">
                                    <i class="bi bi-lock me-1"></i> HTTPS Traffic (Port 443)
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Subnet to Inspect -->
                    <h6 class="text-primary mb-3"><i class="bi bi-hdd-network me-1"></i> Network Range</h6>
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label class="form-label">Subnet to Inspect</label>
                            <input type="text" class="form-control" id="interceptSubnet" value="192.168.10.0/24"
                                   placeholder="e.g., 192.168.10.0/24">
                            <small class="text-muted">Traffic from this subnet will be inspected</small>
                        </div>
                    </div>

                    <div class="d-flex justify-content-end gap-2">
                        <button type="button" class="btn btn-outline-secondary" onclick="loadConfig()">
                            <i class="bi bi-arrow-counterclockwise me-1"></i> Reset
                        </button>
                        <button type="button" class="btn btn-primary" onclick="saveConfig()">
                            <i class="bi bi-save me-1"></i> Save Configuration
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Panel -->
        <div class="col-lg-4">
            <!-- Active Interfaces -->
            <div class="card border-0 shadow-sm mb-3">
                <div class="card-header bg-transparent">
                    <h5 class="mb-0"><i class="bi bi-check2-circle me-2"></i>Active Inspection</h5>
                </div>
                <div class="card-body">
                    <div id="activeInterfaces">
                        <p class="text-muted mb-0">No interfaces being inspected</p>
                    </div>
                </div>
            </div>

            <!-- Logs -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-journal-text me-2"></i>Inspection Log</h5>
                    <button class="btn btn-sm btn-outline-secondary" onclick="refreshLogs()">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
                <div class="card-body p-0">
                    <div id="logContainer" class="bg-dark text-light p-3" 
                         style="max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px;">
                        <div class="text-muted">No logs available</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentStatus = {};
let currentConfig = {};
let availableInterfaces = [];

document.addEventListener('DOMContentLoaded', function() {
    loadInterfaces();
    loadConfig();
    refreshStatus();
    refreshLogs();
    
    // Auto-refresh every 5 seconds
    setInterval(refreshStatus, 5000);
});

async function loadInterfaces() {
    try {
        const response = await fetch('/api/interfaces');
        const data = await response.json();
        availableInterfaces = data.filter(iface => 
            iface.name !== 'local0' && 
            !iface.name.startsWith('tap') &&
            iface.ip_addresses && iface.ip_addresses.length > 0
        );
        renderInterfaceList();
    } catch (error) {
        console.error('Failed to load interfaces:', error);
    }
}

function renderInterfaceList() {
    const container = document.getElementById('interfaceList');
    if (availableInterfaces.length === 0) {
        container.innerHTML = '<div class="text-muted">No interfaces available</div>';
        return;
    }

    container.innerHTML = availableInterfaces.map(iface => {
        const displayName = iface.tag || iface.name;
        const ip = iface.ip_addresses[0] || '';
        const isChecked = currentConfig.lan_interface === iface.name ? 'checked' : '';
        
        return `
            <div class="form-check border rounded p-2 me-2 mb-2" style="min-width: 150px;">
                <input class="form-check-input" type="radio" name="lanInterface" 
                       id="iface_${iface.name.replace(/\//g, '_')}" value="${iface.name}" ${isChecked}
                       onchange="updateSubnetFromInterface(this)">
                <label class="form-check-label" for="iface_${iface.name.replace(/\//g, '_')}">
                    <strong>${displayName}</strong>
                    <br><small class="text-muted">${ip}</small>
                </label>
            </div>
        `;
    }).join('');
}

function updateSubnetFromInterface(radio) {
    const iface = availableInterfaces.find(i => i.name === radio.value);
    if (iface && iface.ip_addresses && iface.ip_addresses.length > 0) {
        const ip = iface.ip_addresses[0];
        const parts = ip.split('/')[0].split('.');
        const subnet = parts[0] + '.' + parts[1] + '.' + parts[2] + '.0/24';
        document.getElementById('interceptSubnet').value = subnet;
    }
}

async function loadConfig() {
    try {
        const response = await fetch('/api/tls-interception/config');
        const result = await response.json();
        if (result.success) {
            currentConfig = result.data;
            populateForm(result.data);
            renderInterfaceList();
        }
    } catch (error) {
        console.error('Failed to load config:', error);
    }
}

function populateForm(config) {
    document.getElementById('interceptSubnet').value = config.intercept_subnet || '192.168.10.0/24';
    document.getElementById('interceptHTTP').checked = config.intercept_http !== false;
    document.getElementById('interceptHTTPS').checked = config.intercept_https !== false;
}

async function refreshStatus() {
    try {
        const response = await fetch('/api/tls-interception/simple-status');
        const result = await response.json();
        if (result.success) {
            currentStatus = result.data;
            updateStatusUI(result.data);
        }
    } catch (error) {
        console.error('Failed to refresh status:', error);
    }
}

function updateStatusUI(status) {
    const statusIndicator = document.getElementById('statusIndicator');
    const statusText = document.getElementById('statusText');
    const systemIndicator = document.getElementById('systemIndicator');
    const systemText = document.getElementById('systemText');
    const interfaceCount = document.getElementById('interfaceCount');
    const toggleBtn = document.getElementById('toggleBtn');
    const activeInterfaces = document.getElementById('activeInterfaces');

    // Overall status
    if (status.enabled) {
        statusIndicator.innerHTML = '<i class="bi bi-circle-fill text-success"></i>';
        statusText.textContent = 'Active';
        toggleBtn.className = 'btn btn-danger';
        toggleBtn.innerHTML = '<i class="bi bi-stop-circle me-1"></i> Disable';
    } else {
        statusIndicator.innerHTML = '<i class="bi bi-circle-fill text-secondary"></i>';
        statusText.textContent = 'Disabled';
        toggleBtn.className = 'btn btn-success';
        toggleBtn.innerHTML = '<i class="bi bi-play-circle me-1"></i> Enable';
    }

    // System ready
    if (status.system_ready) {
        systemIndicator.innerHTML = '<i class="bi bi-check-circle-fill text-success"></i>';
        systemText.textContent = 'Ready';
    } else {
        systemIndicator.innerHTML = '<i class="bi bi-exclamation-circle-fill text-warning"></i>';
        systemText.textContent = 'Not Ready';
    }

    // Active interfaces
    const interfaces = status.attached_interfaces || [];
    interfaceCount.textContent = interfaces.length;
    
    if (interfaces.length > 0) {
        activeInterfaces.innerHTML = interfaces.map(iface => 
            `<div class="d-flex align-items-center mb-2">
                <i class="bi bi-check-circle-fill text-success me-2"></i>
                <span>${iface}</span>
            </div>`
        ).join('');
    } else {
        activeInterfaces.innerHTML = '<p class="text-muted mb-0">No interfaces being inspected</p>';
    }
}

async function refreshLogs() {
    try {
        const response = await fetch('/api/tls-interception/logs?lines=30');
        const result = await response.json();
        if (result.success && result.data) {
            const container = document.getElementById('logContainer');
            if (result.data.length > 0 && result.data[0] !== 'No inspection logs available') {
                container.innerHTML = result.data.map(line => 
                    `<div class="mb-1">${escapeHtml(line)}</div>`
                ).join('');
                container.scrollTop = container.scrollHeight;
            } else {
                container.innerHTML = '<div class="text-muted">No logs available</div>';
            }
        }
    } catch (error) {
        console.error('Failed to load logs:', error);
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

async function saveConfig() {
    const selectedInterface = document.querySelector('input[name="lanInterface"]:checked');
    
    if (!selectedInterface) {
        showToast('Please select an interface to inspect', 'warning');
        return;
    }

    const iface = availableInterfaces.find(i => i.name === selectedInterface.value);
    let subnet = document.getElementById('interceptSubnet').value;
    
    if (!subnet && iface && iface.ip_addresses && iface.ip_addresses.length > 0) {
        const ip = iface.ip_addresses[0];
        const parts = ip.split('/')[0].split('.');
        subnet = parts[0] + '.' + parts[1] + '.' + parts[2] + '.0/24';
    }

    const config = {
        ...currentConfig,
        lan_interface: selectedInterface.value,
        intercept_subnet: subnet,
        intercept_http: document.getElementById('interceptHTTP').checked,
        intercept_https: document.getElementById('interceptHTTPS').checked
    };

    try {
        const response = await fetch('/api/tls-interception/config', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(config)
        });
        const result = await response.json();
        if (result.success) {
            currentConfig = config;
            showToast('Configuration saved', 'success');
        } else {
            showToast('Failed to save: ' + result.error, 'danger');
        }
    } catch (error) {
        showToast('Error: ' + error.message, 'danger');
    }
}

async function toggleInspection() {
    const isEnabled = currentStatus.enabled;
    const endpoint = isEnabled ? '/api/tls-interception/disable' : '/api/tls-interception/enable';

    if (!isEnabled) {
        await saveConfig();
    }

    try {
        const response = await fetch(endpoint, { method: 'POST' });
        const result = await response.json();
        if (result.success) {
            showToast(isEnabled ? 'Inspection disabled' : 'Inspection enabled', 'success');
            refreshStatus();
            refreshLogs();
        } else {
            showToast('Operation failed: ' + result.error, 'danger');
        }
    } catch (error) {
        showToast('Error: ' + error.message, 'danger');
    }
}

function showToast(message, type) {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} position-fixed bottom-0 end-0 m-3`;
    toast.style.zIndex = '9999';
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}
</script>
{{ end }}
