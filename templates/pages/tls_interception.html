{{ template "base" . }}

{{ define "tls_interception_page" }}
<style>
  .ti-subtitle { color: #6c757d; font-size: .95rem; }
  .ti-card-header { display:flex; justify-content:space-between; align-items:flex-start; gap:1rem; padding:1rem 1.25rem; }
  .ti-inline-help { color:#6c757d; font-size:.9rem; }
  .ti-section-title { font-weight:700; display:flex; align-items:center; gap:.5rem; margin-bottom:.75rem; }
  .ti-section-title i { opacity:.85; }
  .ti-pill {
    display:inline-flex; align-items:center; gap:.5rem;
    padding:.45rem .65rem; border:1px solid rgba(0,0,0,.08);
    border-radius:999px; background:#fff; margin:.25rem .25rem 0 0;
    box-shadow: 0 1px 2px rgba(0,0,0,.03);
  }
  .ti-pill .btn-close { font-size:.7rem; }
  .ti-muted { color:#6c757d; font-size:.9rem; }
  .ti-pre { background:#0b1220; color:#e9ecef; border-radius:.75rem; padding:.9rem; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:.85rem; white-space:pre-wrap; }
  .ti-actions { display:flex; align-items:center; gap:.5rem; flex-wrap:wrap; }
  .ti-badge-soft { background: rgba(255,193,7,.15); color: #8a6d00; border:1px solid rgba(255,193,7,.25); }
</style>

<div class="container-fluid py-4">
  <!-- Header -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
        <div>
          <h3 class="mb-1"><i class="bi bi-shield-lock me-2"></i>Traffic Inspection</h3>
          <div class="ti-subtitle">Inspect HTTP/HTTPS (and custom TCP ports) from selected LAN interfaces</div>
        </div>

        <div class="ti-actions">
          <span id="dirtyBadge" class="badge ti-badge-soft" style="display:none;">
            <i class="bi bi-exclamation-triangle me-1"></i>Unsaved changes
          </span>

          <button id="toggleBtn" class="btn btn-success" onclick="toggleInspection()">
            <i class="bi bi-play-circle me-1"></i> Enable
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Status Cards -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card border-0 shadow-sm">
        <div class="card-body text-center">
          <div id="statusIndicator" class="fs-1 mb-2"><i class="bi bi-circle-fill text-secondary"></i></div>
          <h6 class="text-muted mb-0">Inspection Status</h6>
          <span id="statusText" class="fw-bold">Disabled</span>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card border-0 shadow-sm">
        <div class="card-body text-center">
          <div id="proxyIndicator" class="fs-1 mb-2"><i class="bi bi-circle-fill text-secondary"></i></div>
          <h6 class="text-muted mb-0">Proxy Status</h6>
          <span id="proxyText" class="fw-bold">Stopped</span>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card border-0 shadow-sm">
        <div class="card-body text-center">
          <div class="fs-1 mb-2"><i class="bi bi-ethernet text-primary"></i></div>
          <h6 class="text-muted mb-0">Active Interfaces</h6>
          <span id="interfaceCount" class="fw-bold">0</span>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card border-0 shadow-sm">
        <div class="card-body text-center">
          <div class="fs-1 mb-2"><i class="bi bi-plug text-info"></i></div>
          <h6 class="text-muted mb-0">Active Ports</h6>
          <span id="activePortsText" class="fw-bold">None</span>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- Left: Config -->
    <div class="col-lg-8">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-transparent ti-card-header">
          <div>
            <h5 class="mb-0"><i class="bi bi-gear me-2"></i>Configuration</h5>
            <div class="ti-inline-help">Apply changes updates ABF/ACL + iptables live (no full restart).</div>
          </div>

          <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary btn-sm" onclick="reloadConfig()">
              <i class="bi bi-arrow-counterclockwise me-1"></i> Reset
            </button>
            <button class="btn btn-primary btn-sm" id="applyBtn" onclick="saveConfig()" disabled>
              <i class="bi bi-check2-circle me-1"></i> Apply changes
            </button>
          </div>
        </div>

        <div class="card-body">
          <!-- Interfaces -->
          <div class="mb-4">
            <div class="ti-section-title"><i class="bi bi-diagram-3"></i>Interfaces to inspect</div>

            <div class="row g-2 align-items-end">
              <div class="col-md-9">
                <label class="form-label small mb-1">Add interface</label>
                <select class="form-select" id="ifaceSelect">
                  <option value="">Loading interfaces…</option>
                </select>
                <div class="ti-inline-help mt-1">
                  Shows <b>tag</b> (if exists) + interface name + first IP. List excludes already-selected interfaces.
                </div>
              </div>
              <div class="col-md-3">
                <button class="btn btn-outline-primary w-100" onclick="addSelectedInterface()">
                  <i class="bi bi-plus-circle me-1"></i> Add
                </button>
              </div>
            </div>

            <div class="mt-3">
              <div class="small text-muted mb-1">Selected interfaces:</div>
              <div id="selectedInterfacesWrap"></div>
              <div id="noSelectedInterfaces" class="text-muted" style="display:none;">No interfaces selected yet.</div>
            </div>
          </div>

          <hr>

          <!-- Ports -->
          <div class="mb-4">
            <div class="ti-section-title"><i class="bi bi-funnel"></i>Ports to intercept</div>

            <div class="row g-2 align-items-end">
              <div class="col-md-6">
                <label class="form-label small mb-1">Add port</label>
                <input type="number" class="form-control" id="portInput" min="1" max="65535" placeholder="e.g. 80, 443, 8080, 5000">
              </div>
              <div class="col-md-3">
                <button class="btn btn-outline-primary w-100" onclick="addPortFromInput()">
                  <i class="bi bi-plus-circle me-1"></i> Add
                </button>
              </div>
              <div class="col-md-3">
                <div class="d-flex gap-2">
                  <button class="btn btn-outline-secondary w-100" onclick="quickAddPort(80)">HTTP</button>
                  <button class="btn btn-outline-secondary w-100" onclick="quickAddPort(443)">HTTPS</button>
                </div>
              </div>
            </div>

            <div class="mt-3">
              <div class="small text-muted mb-1">Selected ports:</div>
              <div id="selectedPortsWrap"></div>
              <div id="noSelectedPorts" class="text-muted" style="display:none;">No ports selected yet.</div>
              <div class="ti-inline-help mt-2">
                You can intercept any TCP ports (e.g. <code>8000</code>, <code>5000</code>, <code>8080</code>).
              </div>
            </div>
          </div>

          <hr>

          <!-- Excluded URLs -->
          <div class="mb-2">
            <div class="ti-section-title"><i class="bi bi-slash-circle"></i>Excluded URL patterns</div>

            <div class="row g-2 align-items-end">
              <div class="col-md-9">
                <label class="form-label small mb-1">Add pattern</label>
                <input type="text" class="form-control" id="excludeInput" placeholder="e.g. google-analytics.com, /metrics, healthcheck">
                <div class="ti-inline-help mt-1">
                  Simple substring match against host + full URL to reduce noise in the URL logs.
                </div>
              </div>
              <div class="col-md-3">
                <button class="btn btn-outline-primary w-100" onclick="addExcludeFromInput()">
                  <i class="bi bi-plus-circle me-1"></i> Add
                </button>
              </div>
            </div>

            <div class="mt-3">
              <div class="small text-muted mb-1">Active exclusions:</div>
              <div id="excludeWrap"></div>
              <div id="noExcludes" class="text-muted" style="display:none;">No exclusions configured.</div>
            </div>

            <div class="mt-3">
              <label class="form-label small mb-1">Bulk add (one per line)</label>
              <textarea class="form-control" id="excludeBulk" rows="4" placeholder="example.com&#10;/health&#10;/metrics"></textarea>
              <div class="d-flex justify-content-end mt-2">
                <button class="btn btn-outline-secondary btn-sm" onclick="addExcludesFromBulk()">
                  <i class="bi bi-list-check me-1"></i> Add lines
                </button>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- Right: Runtime + CA -->
    <div class="col-lg-4">
      <div class="card border-0 shadow-sm mb-3">
        <div class="card-header bg-transparent">
          <h5 class="mb-0"><i class="bi bi-activity me-2"></i>Runtime</h5>
        </div>
        <div class="card-body">
          <div class="mb-2"><span class="ti-muted">Enabled:</span> <span id="rtEnabled">—</span></div>
          <div class="mb-2"><span class="ti-muted">Proxy:</span> <span id="rtProxy">—</span></div>
          <div class="mb-2"><span class="ti-muted">Interfaces:</span> <span id="rtIfaces">—</span></div>
          <div class="mb-3"><span class="ti-muted">Ports:</span> <span id="rtPorts">—</span></div>

          <div id="runtimeWarning" class="alert alert-warning mb-0" style="display:none;">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <span id="runtimeWarningText"></span>
          </div>
        </div>
      </div>

      <div class="card border-0 shadow-sm mb-3">
        <div class="card-header bg-transparent">
          <h5 class="mb-0"><i class="bi bi-file-earmark-lock me-2"></i>CA certificate</h5>
        </div>
        <div class="card-body">
          <div class="ti-inline-help mb-2">
            Upload a ready-to-use PEM that contains <b>certificate + private key</b>.
            Backend will store it at the fixed location used by mitmproxy.
          </div>

          <div class="ti-pre mb-3">/root/.mitmproxy/mitmproxy-ca.pem</div>

          <div class="d-flex align-items-center gap-2 mb-3">
            <span class="ti-muted">Current status:</span>
            <span id="caStatusBadge" class="badge text-bg-secondary">Loading…</span>
          </div>

          <div class="mb-3">
            <label class="form-label small mb-1">Upload CA bundle (PEM)</label>
            <input class="form-control" type="file" id="caFile" accept=".pem,.crt,.key,.txt">
            <div class="ti-inline-help mt-1">Field name: <code>certificate</code></div>
          </div>

          <button class="btn btn-outline-primary w-100" id="uploadCaBtn" onclick="uploadCA()">
            <i class="bi bi-upload me-1"></i> Upload CA
          </button>

          <hr class="my-3">

          <!-- Interactive docs -->
          <div class="accordion" id="tlsDocs">
            <div class="accordion-item">
              <h2 class="accordion-header" id="hGen">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#cGen">
                  Create a mitmproxy CA (recommended)
                </button>
              </h2>
              <div id="cGen" class="accordion-collapse collapse" data-bs-parent="#tlsDocs">
                <div class="accordion-body">
                  <div class="ti-inline-help mb-2">Run once to generate default CA files:</div>
                  <div class="ti-pre">sudo -H mkdir -p /root/.mitmproxy
sudo -H mitmdump --set confdir=/root/.mitmproxy --listen-host 127.0.0.1 --listen-port 8080
# wait 2–3 seconds, then Ctrl+C
# files appear in /root/.mitmproxy</div>
                  <div class="ti-inline-help mt-2">
                    Then you can export/import the CA cert to client devices as needed.
                  </div>
                </div>
              </div>
            </div>

            <div class="accordion-item">
              <h2 class="accordion-header" id="hOwn">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#cOwn">
                  Use an enterprise CA / purchased CA (placeholder)
                </button>
              </h2>
              <div id="cOwn" class="accordion-collapse collapse" data-bs-parent="#tlsDocs">
                <div class="accordion-body">
                  <div class="ti-inline-help mb-2">
                    Put your organization steps here (placeholder). Example:
                  </div>
                  <ul class="small mb-2">
                    <li>Generate key + cert via internal PKI</li>
                    <li>Export as single PEM bundle (cert + key)</li>
                    <li>Upload using the button above</li>
                  </ul>
                  <div class="ti-inline-help">
                    File must contain <code>BEGIN CERTIFICATE</code> and <code>PRIVATE KEY</code>.
                  </div>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>

      <div class="card border-0 shadow-sm">
        <div class="card-header bg-transparent">
          <h5 class="mb-0"><i class="bi bi-lightbulb me-2"></i>Tips</h5>
        </div>
        <div class="card-body">
          <ul class="mb-0 small">
            <li>Select LAN-facing interfaces (TAP interfaces are hidden).</li>
            <li>If enable fails, check the warning panel and mitmproxy error log.</li>
            <li>Exclusions reduce noise (analytics, health checks, metrics).</li>
          </ul>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
/**
 * Backend endpoints:
 *  - GET  /api/interfaces
 *  - GET  /api/tls-interception/config
 *  - PUT  /api/tls-interception/config
 *  - GET  /api/tls-interception/simple-status
 *  - POST /api/tls-interception/enable | /disable
 *  - GET  /api/tls-interception/certificates
 *  - POST /api/tls-interception/certificates/upload  (multipart field: certificate)
 */
/**
 * Converts a Host IP (192.168.1.50/24) to a Network Subnet (192.168.1.0/24)
 */
function getNetworkSubnet(cidr) {
  if (!cidr || !cidr.includes('/')) return cidr;
  
  const [ip, mask] = cidr.split('/');
  const octets = ip.split('.');
  
  // Zero out octets based on common masks
  if (mask === '24') {
    return `${octets[0]}.${octets[1]}.${octets[2]}.0/24`;
  } else if (mask === '16') {
    return `${octets[0]}.${octets[1]}.0.0/16`;
  } else if (mask === '8') {
    return `${octets[0]}.0.0.0/8`;
  }
  
  return cidr; // Return as-is for non-standard masks
}
let currentStatus = {};
let currentConfig = {
  lan_interfaces: [],
  intercept_ports: [],
  intercept_subnets: [],
  excluded_urls: []
};

let availableInterfaces = [];
let isDirty = false;
let isRefreshing = false;
let isActionBusy = false;

document.addEventListener('DOMContentLoaded', async function() {
  await reloadAll();
  setInterval(() => refreshStatus(false), 5000);
  setInterval(() => loadCertInfo(false), 15000);
});

async function reloadAll() {
  await Promise.allSettled([reloadConfig(), refreshStatus(true), loadInterfaces(), loadCertInfo(true)]);
  renderAll();
}

async function reloadConfig() {
  try {
    const result = await fetchJSON('/api/tls-interception/config');
    if (result && result.success) {
      currentConfig = normalizeConfig(result.data || {});
      setDirty(false);
      renderSelectedInterfaces();
      renderSelectedPorts();
      renderExcludes();
      fillIfaceDropdown();
    } else {
      showToast('Failed to load config', 'danger');
    }
  } catch (e) {
    showToast('Failed to load config: ' + e.message, 'danger');
  }
}

async function loadInterfaces() {
  try {
    const data = await fetchJSON('/api/interfaces');
    let list = Array.isArray(data) ? data : (data && data.data ? data.data : []);
    availableInterfaces = (list || []).filter(iface =>
      iface &&
      iface.name &&
      iface.name !== 'local0' &&
      !String(iface.name).startsWith('tap') &&
      iface.ip_addresses &&
      iface.ip_addresses.length > 0
    );
    fillIfaceDropdown();
    renderSelectedInterfaces();
  } catch (e) {
    availableInterfaces = [];
    fillIfaceDropdown();
  }
}

async function refreshStatus(force) {
  if (isRefreshing && !force) return;
  isRefreshing = true;
  try {
    const result = await fetchJSON('/api/tls-interception/simple-status');
    if (result && result.success) {
      currentStatus = result.data || {};
      updateStatusUI(currentStatus);
    }
  } finally {
    isRefreshing = false;
  }
}

function normalizeConfig(cfg) {
  const out = {...cfg};
  out.lan_interfaces = Array.isArray(out.lan_interfaces) ? out.lan_interfaces : (out.lan_interface ? [out.lan_interface] : []);
  out.intercept_ports = Array.isArray(out.intercept_ports) ? out.intercept_ports : derivePortsFromLegacy(out);

  // FIX: backend uses "excluded_urls"
  if (Array.isArray(out.excluded_urls)) out.excluded_urls = out.excluded_urls;
  else if (Array.isArray(out.exclude_urls)) out.excluded_urls = out.exclude_urls; // tolerate old key
  else out.excluded_urls = [];

  out.lan_interfaces = dedupeStrings(out.lan_interfaces);
  out.intercept_ports = dedupePorts(out.intercept_ports);
  out.excluded_urls = dedupeStrings(out.excluded_urls);
  return out;
}

function derivePortsFromLegacy(cfg) {
  const ports = [];
  if (cfg.intercept_http !== false) ports.push(80);
  if (cfg.intercept_https !== false) ports.push(443);
  return ports;
}

function renderAll() {
  fillIfaceDropdown();
  renderSelectedInterfaces();
  renderSelectedPorts();
  renderExcludes();
  updateStatusUI(currentStatus);
}

function fillIfaceDropdown() {
  const sel = document.getElementById('ifaceSelect');
  if (!sel) return;

  const selected = new Set((currentConfig.lan_interfaces || []).map(String));
  const options = availableInterfaces
    .filter(iface => !selected.has(String(iface.name)))
    .map(iface => {
      const displayName = iface.tag ? `${iface.tag} (${iface.name})` : iface.name;
      const ip = (iface.ip_addresses && iface.ip_addresses[0]) ? iface.ip_addresses[0] : '';
      return { value: iface.name, label: `${displayName} — ${ip}` };
    });

  sel.innerHTML = '';
  const placeholder = document.createElement('option');
  placeholder.value = '';
  placeholder.textContent = options.length ? 'Select interface…' : 'No more interfaces available';
  sel.appendChild(placeholder);

  for (const opt of options) {
    const o = document.createElement('option');
    o.value = opt.value;
    o.textContent = opt.label;
    sel.appendChild(o);
  }
}

function renderSelectedInterfaces() {
  const wrap = document.getElementById('selectedInterfacesWrap');
  const empty = document.getElementById('noSelectedInterfaces');
  if (!wrap || !empty) return;

  const selected = currentConfig.lan_interfaces || [];
  wrap.innerHTML = '';

  if (selected.length === 0) { empty.style.display = 'block'; return; }
  empty.style.display = 'none';

  for (const ifaceName of selected) {
    const iface = availableInterfaces.find(i => String(i.name) === String(ifaceName));
    const displayName = iface ? (iface.tag ? `${iface.tag} (${iface.name})` : iface.name) : ifaceName;
    const ip = iface?.ip_addresses?.[0] || '';

    const pill = document.createElement('span');
    pill.className = 'ti-pill';
    pill.innerHTML = `
      <i class="bi bi-ethernet text-primary"></i>
      <span><b>${escapeHtml(displayName)}</b>${ip ? ` <span class="ti-muted">— ${escapeHtml(ip)}</span>` : ''}</span>
      <button type="button" class="btn-close ms-2" aria-label="Remove"></button>
    `;
    pill.querySelector('.btn-close').addEventListener('click', () => removeInterface(ifaceName));
    wrap.appendChild(pill);
  }
}
function syncSubnetsFromSelectedInterfaces() {
  const subnets = [];
  
  // Loop through every name in our selected list
  for (const name of currentConfig.lan_interfaces) {
    // Find the matching hardware info to get the IP
    const info = availableInterfaces.find(i => String(i.name) === String(name));
    const firstIp = info?.ip_addresses?.[0];
    
    if (firstIp) {
      subnets.push(getNetworkSubnet(firstIp));
    }
  }
  
  // Update the global config with deduped subnets
  currentConfig.intercept_subnets = dedupeStrings(subnets);
}
function addSelectedInterface() {
  const sel = document.getElementById('ifaceSelect');
  const val = sel ? sel.value : '';
  if (!val) return showToast('Select an interface first', 'warning');

  currentConfig.lan_interfaces = dedupeStrings([...(currentConfig.lan_interfaces || []), val]);
  
  // Update the subnets based on the new list of interfaces
  syncSubnetsFromSelectedInterfaces();

  console.log(currentConfig);

  setDirty(true);
  if (sel) sel.value = '';
  fillIfaceDropdown();
  renderSelectedInterfaces();
}

function removeInterface(name) {
  currentConfig.lan_interfaces = (currentConfig.lan_interfaces || []).filter(x => String(x) !== String(name));
  
  // Re-sync subnets so the removed interface's subnet is gone
  syncSubnetsFromSelectedInterfaces();

  setDirty(true);
  fillIfaceDropdown();
  renderSelectedInterfaces();
}
function renderSelectedPorts() {
  const wrap = document.getElementById('selectedPortsWrap');
  const empty = document.getElementById('noSelectedPorts');
  if (!wrap || !empty) return;

  const ports = (currentConfig.intercept_ports || []).slice().sort((a,b)=>a-b);
  wrap.innerHTML = '';

  if (ports.length === 0) { empty.style.display = 'block'; return; }
  empty.style.display = 'none';

  for (const p of ports) {
    const label = (p === 80) ? '80 (HTTP)' : (p === 443) ? '443 (HTTPS)' : String(p);
    const pill = document.createElement('span');
    pill.className = 'ti-pill';
    pill.innerHTML = `
      <i class="bi bi-plug text-info"></i>
      <span><b>${escapeHtml(label)}</b></span>
      <button type="button" class="btn-close ms-2" aria-label="Remove"></button>
    `;
    pill.querySelector('.btn-close').addEventListener('click', () => removePort(p));
    wrap.appendChild(pill);
  }
}

function quickAddPort(p) { addPort(p); }

function addPortFromInput() {
  const input = document.getElementById('portInput');
  const p = parseInt(input?.value || '', 10);
  if (!Number.isFinite(p) || p < 1 || p > 65535) return showToast('Enter a valid port (1..65535)', 'warning');
  addPort(p);
  if (input) input.value = '';
}

function addPort(p) {
  currentConfig.intercept_ports = dedupePorts([...(currentConfig.intercept_ports || []), p]);
  setDirty(true);
  renderSelectedPorts();
}

function removePort(p) {
  currentConfig.intercept_ports = (currentConfig.intercept_ports || []).filter(x => Number(x) !== Number(p));
  setDirty(true);
  renderSelectedPorts();
}

function renderExcludes() {
  const wrap = document.getElementById('excludeWrap');
  const empty = document.getElementById('noExcludes');
  if (!wrap || !empty) return;

  const list = currentConfig.excluded_urls || [];
  wrap.innerHTML = '';

  if (list.length === 0) { empty.style.display = 'block'; return; }
  empty.style.display = 'none';

  for (const s of list) {
    const pill = document.createElement('span');
    pill.className = 'ti-pill';
    pill.innerHTML = `
      <i class="bi bi-slash-circle text-danger"></i>
      <span><b>${escapeHtml(s)}</b></span>
      <button type="button" class="btn-close ms-2" aria-label="Remove"></button>
    `;
    pill.querySelector('.btn-close').addEventListener('click', () => removeExclude(s));
    wrap.appendChild(pill);
  }
}

function addExcludeFromInput() {
  const input = document.getElementById('excludeInput');
  const val = (input?.value || '').trim();
  if (!val) return showToast('Enter a pattern first', 'warning');
  addExclude(val);
  if (input) input.value = '';
}

function addExcludesFromBulk() {
  const ta = document.getElementById('excludeBulk');
  const raw = ta ? ta.value : '';
  const lines = raw.split('\n').map(x => x.trim()).filter(Boolean);
  if (lines.length === 0) return showToast('No lines to add', 'warning');

  let added = 0;
  for (const line of lines) if (addExclude(line, true)) added++;
  if (ta) ta.value = '';
  if (added > 0) showToast(`Added ${added} exclusion(s)`, 'success');
  renderExcludes();
}

function addExclude(s, silent=false) {
  const list = currentConfig.excluded_urls || [];
  if (list.includes(s)) return false;
  currentConfig.excluded_urls = dedupeStrings([...list, s]);
  setDirty(true);
  if (!silent) renderExcludes();
  return true;
}

function removeExclude(s) {
  currentConfig.excluded_urls = (currentConfig.excluded_urls || []).filter(x => String(x) !== String(s));
  setDirty(true);
  renderExcludes();
}

function setDirty(flag) {
  isDirty = !!flag;
  const badge = document.getElementById('dirtyBadge');
  const applyBtn = document.getElementById('applyBtn');
  if (badge) badge.style.display = isDirty ? 'inline-block' : 'none';
  if (applyBtn) applyBtn.disabled = !isDirty || isActionBusy;
}

async function saveConfig() {
  const ifaces = currentConfig.lan_interfaces || [];
  const ports = currentConfig.intercept_ports || [];
  
  if (ifaces.length === 0) return showToast('Select at least one interface', 'warning');
  if (ports.length === 0) return showToast('Add at least one port', 'warning');

  const applyBtn = document.getElementById('applyBtn');
  const oldHtml = applyBtn ? applyBtn.innerHTML : '';
  isActionBusy = true;
  if (applyBtn) {
    applyBtn.disabled = true;
    applyBtn.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span>Applying…`;
  }

  try {
    // --- FIX: GENERATE SUBNETS FROM SELECTED INTERFACES ---
    const derivedSubnets = ifaces.map(name => {
      const info = availableInterfaces.find(i => String(i.name) === String(name));
      const firstIp = info?.ip_addresses?.[0];
      return firstIp ? getNetworkSubnet(firstIp) : null;
    }).filter(Boolean);

    const payload = {
      // Include base settings (IDs, names, etc) if they exist in currentConfig
      ...currentConfig, 
      lan_interfaces: dedupeStrings(ifaces),
      intercept_ports: dedupePorts(ports),
      excluded_urls: dedupeStrings(currentConfig.excluded_urls || []),
      // Plural key to match updated Go struct
      intercept_subnets: dedupeStrings(derivedSubnets) 
    };

    const res = await fetchJSON('/api/tls-interception/config', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (res && res.success) {
      currentConfig = normalizeConfig(res.data || payload);
      setDirty(false);
      showToast('Configuration applied', 'success');
      await refreshStatus(true);
      fillIfaceDropdown();
      renderSelectedInterfaces();
      renderSelectedPorts();
      renderExcludes();
      return true;
    }
    showToast('Failed to apply: ' + (res?.error || 'unknown error'), 'danger');
    return false;
  } catch (e) {
    showToast('Failed to apply: ' + e.message, 'danger');
    return false;
  } finally {
    isActionBusy = false;
    if (applyBtn) {
      applyBtn.innerHTML = oldHtml;
      applyBtn.disabled = !isDirty;
    }
  }
}

async function toggleInspection() {
  if (isActionBusy) return;
  isActionBusy = true;

  const toggleBtn = document.getElementById('toggleBtn');
  const isEnabled = !!currentStatus.enabled;
  const endpoint = isEnabled ? '/api/tls-interception/disable' : '/api/tls-interception/enable';

  // enabling: auto-apply if dirty
  if (!isEnabled && isDirty) {
    const ok = await saveConfig();
    if (!ok) { isActionBusy = false; return; }
  }

  // basic validation before enabling
  if (!isEnabled) {
    if ((currentConfig.lan_interfaces || []).length === 0) { showToast('Select at least one interface', 'warning'); isActionBusy=false; return; }
    if ((currentConfig.intercept_ports || []).length === 0) { showToast('Add at least one port', 'warning'); isActionBusy=false; return; }
  }

  const old = toggleBtn ? toggleBtn.innerHTML : '';
  if (toggleBtn) {
    toggleBtn.disabled = true;
    toggleBtn.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span>${isEnabled ? 'Disabling…' : 'Enabling…'}`;
  }

  try {
    const res = await fetchJSON(endpoint, { method: 'POST' });
    if (!res || !res.success) {
      showToast('Operation failed: ' + (res?.error || 'unknown error'), 'danger');
      await refreshStatus(true);
      return;
    }

    // Wait a bit for system to settle (especially enable)
    await waitForDesiredState(!isEnabled);

    showToast(isEnabled ? 'Inspection disabled' : 'Inspection enabled', 'success');
  } catch (e) {
    showToast('Operation failed: ' + e.message, 'danger');
  } finally {
    isActionBusy = false;
    if (toggleBtn) {
      toggleBtn.disabled = false;
      toggleBtn.innerHTML = old;
    }
    await refreshStatus(true);
    setDirty(isDirty);
  }
}

async function waitForDesiredState(shouldBeEnabled) {
  for (let i=0; i<10; i++) {
    await refreshStatus(true);
    if (!!currentStatus.enabled === !!shouldBeEnabled) return true;
    await sleep(400);
  }
  return false;
}

function updateStatusUI(status) {
  const statusIndicator = document.getElementById('statusIndicator');
  const statusText = document.getElementById('statusText');
  const proxyIndicator = document.getElementById('proxyIndicator');
  const proxyText = document.getElementById('proxyText');
  const interfaceCount = document.getElementById('interfaceCount');
  const activePortsText = document.getElementById('activePortsText');
  const toggleBtn = document.getElementById('toggleBtn');

  const enabled = !!status.enabled;
  const proxy = !!status.mitmproxy_running;
  const ports = Array.isArray(status.active_ports) ? status.active_ports : [];
  const ifaces = Array.isArray(status.attached_interfaces) ? status.attached_interfaces : [];

  if (enabled) {
    if (statusIndicator) statusIndicator.innerHTML = '<i class="bi bi-circle-fill text-success"></i>';
    if (statusText) statusText.textContent = 'Active';
    if (toggleBtn && !isActionBusy) {
      toggleBtn.className = 'btn btn-danger';
      toggleBtn.innerHTML = '<i class="bi bi-stop-circle me-1"></i> Disable';
    }
  } else {
    if (statusIndicator) statusIndicator.innerHTML = '<i class="bi bi-circle-fill text-secondary"></i>';
    if (statusText) statusText.textContent = 'Disabled';
    if (toggleBtn && !isActionBusy) {
      toggleBtn.className = 'btn btn-success';
      toggleBtn.innerHTML = '<i class="bi bi-play-circle me-1"></i> Enable';
    }
  }

  if (proxy) {
    if (proxyIndicator) proxyIndicator.innerHTML = '<i class="bi bi-circle-fill text-success"></i>';
    if (proxyText) proxyText.textContent = 'Running';
  } else {
    if (proxyIndicator) proxyIndicator.innerHTML = '<i class="bi bi-circle-fill text-danger"></i>';
    if (proxyText) proxyText.textContent = 'Stopped';
  }

  if (activePortsText) activePortsText.textContent = ports.length ? ports.join(', ') : 'None';
  if (interfaceCount) interfaceCount.textContent = String(ifaces.length);

  const rtEnabled = document.getElementById('rtEnabled');
  const rtProxy = document.getElementById('rtProxy');
  const rtIfaces = document.getElementById('rtIfaces');
  const rtPorts = document.getElementById('rtPorts');

  if (rtEnabled) rtEnabled.innerHTML = enabled ? '<span class="badge text-bg-success">Yes</span>' : '<span class="badge text-bg-secondary">No</span>';
  if (rtProxy) rtProxy.innerHTML = proxy ? '<span class="badge text-bg-success">Running</span>' : '<span class="badge text-bg-danger">Stopped</span>';
  if (rtIfaces) rtIfaces.textContent = ifaces.length ? ifaces.join(', ') : '—';
  if (rtPorts) rtPorts.textContent = ports.length ? ports.join(', ') : '—';

  const warn = document.getElementById('runtimeWarning');
  const warnText = document.getElementById('runtimeWarningText');
  let msg = '';
  if (enabled && !proxy) msg = 'Proxy is not running. Traffic may not be inspected.';
  if (status.error_message) msg = status.error_message;

  if (warn && warnText) {
    if (msg) {
      warnText.textContent = msg;
      warn.style.display = 'block';
    } else {
      warn.style.display = 'none';
    }
  }
}

// ---- CA upload ----
async function loadCertInfo(showErrors) {
  try {
    const res = await fetchJSON('/api/tls-interception/certificates');
    if (!res || !res.success) {
      if (showErrors) showToast('Failed to load certificate info', 'danger');
      return;
    }
    const info = res.data || {};
    const badge = document.getElementById('caStatusBadge');
    const ok = !!info.ca_bundle_exists || !!info.ca_key_exists;
    if (badge) {
      badge.className = 'badge ' + (ok ? 'text-bg-success' : 'text-bg-secondary');
      badge.textContent = ok ? 'CA bundle present' : 'Missing';
    }
  } catch (e) {
    if (showErrors) showToast('Failed to load certificate info: ' + e.message, 'danger');
  }
}

async function uploadCA() {
  const input = document.getElementById('caFile');
  const btn = document.getElementById('uploadCaBtn');
  const file = input?.files?.[0];
  if (!file) return showToast('Choose a PEM file first', 'warning');

  if (file.size > 10 * 1024 * 1024) return showToast('File too large (max 10MB)', 'warning');

  const old = btn ? btn.innerHTML : '';
  if (btn) {
    btn.disabled = true;
    btn.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span>Uploading…`;
  }

  try {
    const fd = new FormData();
    fd.append('certificate', file);

    const r = await fetch('/api/tls-interception/certificates/upload', { method: 'POST', body: fd });
    const text = await r.text();
    let res;
    try { res = JSON.parse(text); } catch { res = { success: false, error: text }; }

    if (res && res.success) {
      showToast('CA uploaded successfully', 'success');
      if (input) input.value = '';
      await loadCertInfo(true);
    } else {
      showToast('Upload failed: ' + (res?.error || 'unknown error'), 'danger');
    }
  } catch (e) {
    showToast('Upload failed: ' + e.message, 'danger');
  } finally {
    if (btn) {
      btn.disabled = false;
      btn.innerHTML = old;
    }
  }
}

// helpers
async function fetchJSON(url, options) {
  const r = await fetch(url, options);
  const text = await r.text();
  try { return JSON.parse(text); } catch { return text; }
}

function dedupeStrings(arr) {
  const out = [];
  const seen = new Set();
  for (const x of (arr || [])) {
    const s = String(x).trim();
    if (!s) continue;
    if (seen.has(s)) continue;
    seen.add(s);
    out.push(s);
  }
  return out;
}

function dedupePorts(arr) {
  const out = [];
  const seen = new Set();
  for (const x of (arr || [])) {
    const n = Number(x);
    if (!Number.isFinite(n)) continue;
    const p = Math.floor(n);
    if (p < 1 || p > 65535) continue;
    if (seen.has(p)) continue;
    seen.add(p);
    out.push(p);
  }
  return out;
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text == null ? '' : String(text);
  return div.innerHTML;
}

function showToast(message, type) {
  const toast = document.createElement('div');
  toast.className = `alert alert-${type} position-fixed bottom-0 end-0 m-3 shadow-sm`;
  toast.style.zIndex = '9999';
  toast.style.maxWidth = '420px';
  toast.innerHTML = `<div class="d-flex align-items-start gap-2">
    <div>${escapeHtml(message)}</div>
    <button type="button" class="btn-close ms-auto" aria-label="Close"></button>
  </div>`;
  toast.querySelector('.btn-close').addEventListener('click', ()=>toast.remove());
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 4000);
}

function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }
</script>
{{ end }}
