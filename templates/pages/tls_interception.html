{{ template "base" . }}

{{ define "tls_interception_page" }}
<style>
  .ti-subtitle {
    color: #6c757d;
    font-size: .95rem;
  }

  .ti-inline-help {
    color: #6c757d;
    font-size: .875rem;
    line-height: 1.5;
  }

  .ti-section-title {
    font-weight: 600;
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: #495057;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #e9ecef;
  }

  .ti-pill {
    display: inline-flex;
    align-items: center;
    gap: .5rem;
    padding: .5rem .75rem;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    background: #f8f9fa;
    margin: 0 .5rem .5rem 0;
    font-size: 0.875rem;
    transition: all 0.2s;
  }

  .ti-pill:hover {
    background: #e9ecef;
    border-color: #adb5bd;
  }

  .ti-pill .btn-close {
    font-size: .7rem;
    opacity: 0.5;
  }

  .ti-pill .btn-close:hover {
    opacity: 1;
  }

  .ti-muted {
    color: #6c757d;
    font-size: .875rem;
  }

  .ti-pre {
    background: #0d1117;
    color: #e6edf3;
    border-radius: 6px;
    padding: 1rem;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-size: .813rem;
    white-space: pre-wrap;
    border: 1px solid #30363d;
  }

  .ti-command-line {
    background-color: #161b22;
    display: block;
    padding: 0.5rem 1rem;
    margin: 0.5rem -1rem;
    border-left: 3px solid #2f81f7;
  }

  .ti-badge-warning {
    background: rgba(255, 193, 7, .1);
    color: #8a6d00;
    border: 1px solid rgba(255, 193, 7, .3);
    padding: 0.35rem 0.65rem;
    border-radius: 4px;
    font-size: 0.813rem;
    font-weight: 500;
  }

  .ti-card {
    border: 1px solid #e9ecef;
    border-radius: 8px;
    background: #fff;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
  }

  .ti-card-header {
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid #e9ecef;
    background: #fafbfc;
    border-radius: 8px 8px 0 0;
  }

  .ti-card-body {
    padding: 1.5rem;
  }

  .ti-form-group {
    margin-bottom: 1.5rem;
  }

  .ti-form-label {
    display: block;
    font-weight: 500;
    font-size: 0.875rem;
    color: #212529;
    margin-bottom: 0.5rem;
  }

  .ti-input-group {
    display: flex;
    gap: 0.5rem;
    align-items: center;
  }

  .ti-status-item {
    padding: 0.75rem 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #f1f3f5;
  }

  .ti-status-item:last-child {
    border-bottom: none;
  }

  .ti-status-label {
    font-size: 0.875rem;
    color: #6c757d;
    font-weight: 500;
  }

  .ti-status-value {
    font-size: 0.875rem;
    color: #212529;
    font-weight: 600;
  }

  .ti-quick-actions {
    display: flex;
    gap: 0.5rem;
  }

  .ti-btn-quick {
    padding: 0.375rem 0.75rem;
    font-size: 0.813rem;
    border-radius: 4px;
  }

  .form-control,
  .form-select {
    border-radius: 6px;
    border-color: #ced4da;
    font-size: 0.875rem;
  }

  .form-control:focus,
  .form-select:focus {
    border-color: #80bdff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, .15);
  }

  .btn {
    border-radius: 6px;
    font-weight: 500;
    padding: 0.5rem 1rem;
    font-size: 0.875rem;
  }

  .ti-empty-state {
    text-align: center;
    padding: 2rem 1rem;
    color: #6c757d;
    font-size: 0.875rem;
  }

  .ti-pills-container {
    min-height: 40px;
    padding: 0.5rem 0;
  }

  .accordion-button {
    font-size: 0.875rem;
    padding: 0.75rem 1rem;
  }

  .accordion-body {
    font-size: 0.875rem;
    padding: 1rem;
  }

  .ti-btn-yellow {
    background-color: rgba(255, 255, 0, 0.15) !important;
    color: #495057;
  }

  .ti-btn-yellow:not(.collapsed) {
    background-color: rgba(255, 255, 0, 0.25) !important;
  }
</style>

<div class="container-fluid py-4">
  <!-- Header -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-start">
        <div>
          <h3 class="mb-2 d-flex align-items-center gap-2">
            <i class="bi bi-shield-lock"></i>
            TLS Traffic Inspection
          </h3>
          <p class="ti-subtitle mb-0">Deep packet inspection for HTTP/HTTPS and custom TCP ports on LAN interfaces</p>
        </div>

        <div class="d-flex align-items-center gap-3">
          <span id="dirtyBadge" class="ti-badge-warning" style="display:none;">
            <i class="bi bi-exclamation-triangle me-1"></i>Unsaved changes
          </span>

          <button id="toggleBtn" class="btn btn-success" onclick="toggleInspection()">
            <i class="bi bi-play-circle me-1"></i> Enable Inspection
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- Left Column: Configuration -->
    <div class="col-lg-8">
      <!-- Interfaces Section -->
      <div class="ti-card mb-4">
        <div class="ti-card-header">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-diagram-3 me-2"></i>Network Interfaces</h5>
            <small class="text-muted">Select LAN interfaces to monitor</small>
          </div>
        </div>
        <div class="ti-card-body">
          <div class="ti-form-group">
            <label class="ti-form-label">Available Interfaces</label>
            <div class="ti-input-group">
              <select class="form-select" id="ifaceSelect">
                <option value="">Loading interfaces…</option>
              </select>
              <button class="btn btn-primary" onclick="addSelectedInterface()" style="flex-shrink: 0;">
                <i class="bi bi-plus-circle me-1"></i> Add
              </button>
            </div>
            <small class="ti-inline-help d-block mt-2">Displays interface tag, name, and primary IP address. TAP interfaces are hidden.</small>
          </div>

          <div class="ti-form-group mb-0">
            <label class="ti-form-label">Selected Interfaces</label>
            <div class="ti-pills-container">
              <div id="selectedInterfacesWrap"></div>
              <div id="noSelectedInterfaces" class="ti-empty-state" style="display:none;">
                <i class="bi bi-inbox text-muted" style="font-size: 2rem;"></i>
                <p class="mb-0 mt-2">No interfaces selected</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Ports Section -->
      <div class="ti-card mb-4">
        <div class="ti-card-header">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-funnel me-2"></i>Intercept Ports</h5>
            <small class="text-muted">TCP ports to capture and inspect</small>
          </div>
        </div>
        <div class="ti-card-body">
          <div class="ti-form-group">
            <label class="ti-form-label">Port Number</label>
            <div class="ti-input-group">
              <input type="number" class="form-control" id="portInput" min="1" max="65535"
                placeholder="Enter port (1-65535)">
              <button class="btn btn-primary" onclick="addPortFromInput()" style="flex-shrink: 0;">
                <i class="bi bi-plus-circle me-1"></i> Add
              </button>
            </div>

            <div class="mt-3">
              <label class="ti-form-label mb-2">Quick Add</label>
              <div class="ti-quick-actions">
                <button class="btn btn-outline-secondary ti-btn-quick" onclick="quickAddPort(80)">
                  <i class="bi bi-globe me-1"></i> HTTP (80)
                </button>
                <button class="btn btn-outline-secondary ti-btn-quick" onclick="quickAddPort(443)">
                  <i class="bi bi-lock me-1"></i> HTTPS (443)
                </button>
                <button class="btn btn-outline-secondary ti-btn-quick" onclick="quickAddPort(8080)">
                  <i class="bi bi-code me-1"></i> Alt HTTP (8080)
                </button>
              </div>
            </div>
          </div>

          <div class="ti-form-group mb-0">
            <label class="ti-form-label">Active Ports</label>
            <div class="ti-pills-container">
              <div id="selectedPortsWrap"></div>
              <div id="noSelectedPorts" class="ti-empty-state" style="display:none;">
                <i class="bi bi-inbox text-muted" style="font-size: 2rem;"></i>
                <p class="mb-0 mt-2">No ports configured</p>
              </div>
            </div>
            <small class="ti-inline-help d-block mt-2">
              You can intercept any TCP port including custom application ports (e.g., 3000, 5000, 9000).
            </small>
          </div>
        </div>
      </div>

      <!-- Exclusions Section -->
      <div class="ti-card mb-4">
        <div class="ti-card-header">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-slash-circle me-2"></i>URL Exclusions</h5>
            <small class="text-muted">Filter out noise from logs</small>
          </div>
        </div>
        <div class="ti-card-body">
          <div class="ti-form-group">
            <label class="ti-form-label">Exclusion Pattern</label>
            <div class="ti-input-group">
              <input type="text" class="form-control" id="excludeInput"
                placeholder="e.g., google-analytics.com, /health, /metrics">
              <button class="btn btn-primary" onclick="addExcludeFromInput()" style="flex-shrink: 0;">
                <i class="bi bi-plus-circle me-1"></i> Add
              </button>
            </div>
            <small class="ti-inline-help d-block mt-2">Substring match against hostname and URL path to exclude from logging.</small>
          </div>

          <div class="ti-form-group">
            <label class="ti-form-label">Active Exclusions</label>
            <div class="ti-pills-container">
              <div id="excludeWrap"></div>
              <div id="noExcludes" class="ti-empty-state" style="display:none;">
                <i class="bi bi-inbox text-muted" style="font-size: 2rem;"></i>
                <p class="mb-0 mt-2">No exclusions configured</p>
              </div>
            </div>
          </div>

          <div class="ti-form-group mb-0">
            <label class="ti-form-label">Bulk Import</label>
            <textarea class="form-control" id="excludeBulk" rows="4"
              placeholder="Enter one pattern per line:&#10;analytics.google.com&#10;/api/health&#10;/metrics"></textarea>
            <div class="d-flex justify-content-end mt-2">
              <button class="btn btn-outline-secondary btn-sm" onclick="addExcludesFromBulk()">
                <i class="bi bi-list-check me-1"></i> Import Lines
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="d-flex justify-content-end gap-2 mb-4">
        <button class="btn btn-outline-secondary" onclick="reloadConfig()">
          <i class="bi bi-arrow-counterclockwise me-1"></i> Reset Changes
        </button>
        <button class="btn btn-success" id="applyBtn" onclick="saveConfig()" disabled>
          <i class="bi bi-check2-circle me-1"></i> Apply Configuration
        </button>
      </div>
    </div>

    <!-- Right Column: Status & CA Management -->
    <div class="col-lg-4">
      <!-- Runtime Status -->
      <div class="ti-card mb-4">
        <div class="ti-card-header">
          <h5 class="mb-0"><i class="bi bi-activity me-2"></i>Runtime Status</h5>
        </div>
        <div class="ti-card-body">
          <div class="ti-status-item">
            <span class="ti-status-label">Inspection</span>
            <span id="rtEnabled" class="ti-status-value">—</span>
          </div>
          <div class="ti-status-item">
            <span class="ti-status-label">Proxy Service</span>
            <span id="rtProxy" class="ti-status-value">—</span>
          </div>
          <div class="ti-status-item">
            <span class="ti-status-label">Active Interfaces</span>
            <span id="rtIfaces" class="ti-status-value">—</span>
          </div>
          <div class="ti-status-item">
            <span class="ti-status-label">Monitored Ports</span>
            <span id="rtPorts" class="ti-status-value">—</span>
          </div>

          <div id="runtimeWarning" class="alert alert-warning mt-3 mb-0" style="display:none; font-size: 0.875rem;">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <span id="runtimeWarningText"></span>
          </div>
        </div>
      </div>

      <!-- CA Certificate Management -->
      <div class="ti-card mb-4">
        <div class="ti-card-header">
          <h5 class="mb-0"><i class="bi bi-file-earmark-lock me-2"></i>CA Certificate</h5>
        </div>
        <div class="ti-card-body">
          <div class="ti-form-group">
            <label class="ti-form-label">Upload New Certificate</label>
            <input class="form-control" type="file" id="caFile" accept=".pem,.crt,.key,.txt">
          </div>

          <button class="btn btn-primary w-100 mb-3" id="uploadCaBtn" onclick="uploadCA()">
            <i class="bi bi-upload me-1"></i> Upload CA Bundle
          </button>

          <!-- Certificate Setup Guide -->
          <div class="accordion accordion-flush" id="tlsDocs">
            <div class="accordion-item">
              <h2 class="accordion-header" id="hGen">
                <button class="accordion-button collapsed ti-btn-yellow" type="button" data-bs-toggle="collapse"
                  data-bs-target="#cGen">
                  <i class="bi bi-question-circle me-2"></i> Generate mitmproxy CA
                </button>
              </h2>
              <div id="cGen" class="accordion-collapse collapse" data-bs-parent="#tlsDocs">
                <div class="accordion-body">
                  <p class="mb-2">Run these commands to generate default CA files:</p>
                  <div class="ti-pre mb-2"># to sign leaf certificates on the fly, this private.key, 4096 bit RSA private
key, is needed and should be kept secret. You can create one using the following command

<div class="ti-command-line">>$ openssl genrsa -out private.key 4096</div>

# The CA-cert.pem file is the public certificate that needs to be distributed to client devices for
trust. It can be generated with this command (valid for 5 years):

<div class="ti-command-line">>$ openssl req -x509 -new -nodes -key private.key -sha256 -days 1825 -out CA-cert.pem</div>

# You should answer the prompts (Country, Organization, Common Name) as you see fit. The Common Name
can be something like "My Company MITM CA". for example:
# Country Name (2 letter code) [AU]:UZ
# State or Province Name (full name) [Some-State]:Tashkent
# Locality Name (eg, city) []:Tashkent
# Organization Name (eg, company) [Internet Widgits Pty Ltd]:CSEC
# Organizational Unit Name (eg, section) []:RnD
# Common Name (e.g. server FQDN or YOUR name) []:csec
# Email Address []:csec@csec.uz

#after successfully creating the CA-cert.pem and private.key files, You then concatenate them into a
single PEM bundle for upload:

<div class="ti-command-line">>$ cat CA-cert.pem private.key > rootCA.pem</div>

# and then, you can upload the rootCA.pem using the upload button above. After successful upload,
the CA certificate will be used for TLS interception.
                  </div>
                  <small class="ti-inline-help">
                    After generation, distribute the CA certificate to client devices for trust.
                  </small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Information -->
      <div class="ti-card">
        <div class="ti-card-header">
          <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Important Notes</h5>
        </div>
        <div class="ti-card-body">
          <ul class="mb-0 small" style="padding-left: 1.25rem; line-height: 1.7;">
            <li>Only LAN-facing interfaces are shown (TAP interfaces excluded)</li>
            <li>Configuration changes apply live without service restart</li>
            <li>URL exclusions help reduce log noise from analytics and health checks</li>
            <li>Ensure CA certificate is trusted on client devices before enabling</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  /**
   * Backend endpoints:
   *  - GET  /api/interfaces
   *  - GET  /api/tls-interception/config
   *  - PUT  /api/tls-interception/config
   *  - GET  /api/tls-interception/simple-status
   *  - POST /api/tls-interception/enable | /disable
   *  - GET  /api/tls-interception/certificates
   *  - POST /api/tls-interception/certificates/upload  (multipart field: certificate)
   */

  /**
   * Converts a Host IP (192.168.1.50/24) to a Network Subnet (192.168.1.0/24)
   */
  function getNetworkSubnet(cidr) {
    if (!cidr || !cidr.includes('/')) return cidr;

    const [ip, mask] = cidr.split('/');
    const octets = ip.split('.');

    // Zero out octets based on common masks
    if (mask === '24') {
      return `${octets[0]}.${octets[1]}.${octets[2]}.0/24`;
    } else if (mask === '16') {
      return `${octets[0]}.${octets[1]}.0.0/16`;
    } else if (mask === '8') {
      return `${octets[0]}.0.0.0/8`;
    }

    return cidr; // Return as-is for non-standard masks
  }

  let currentStatus = {};
  let currentConfig = {
    lan_interfaces: [],
    intercept_ports: [],
    intercept_subnets: [],
    excluded_urls: []
  };

  let availableInterfaces = [];
  let isDirty = false;
  let isRefreshing = false;
  let isActionBusy = false;

  document.addEventListener('DOMContentLoaded', async function () {
    await reloadAll();
    setInterval(() => refreshStatus(false), 5000);
    setInterval(() => loadCertInfo(false), 15000);
  });

  async function reloadAll() {
    await Promise.allSettled([reloadConfig(), refreshStatus(true), loadInterfaces(), loadCertInfo(true)]);
    renderAll();
  }

  async function reloadConfig() {
    try {
      const result = await fetchJSON('/api/tls-interception/config');
      if (result && result.success) {
        currentConfig = normalizeConfig(result.data || {});
        setDirty(false);
        renderSelectedInterfaces();
        renderSelectedPorts();
        renderExcludes();
        fillIfaceDropdown();
      } else {
        showToast('Failed to load config', 'danger');
      }
    } catch (e) {
      showToast('Failed to load config: ' + e.message, 'danger');
    }
  }

  async function loadInterfaces() {
    try {
      const data = await fetchJSON('/api/interfaces');
      let list = Array.isArray(data) ? data : (data && data.data ? data.data : []);
      availableInterfaces = (list || []).filter(iface =>
        iface &&
        iface.name &&
        iface.name !== 'local0' &&
        !String(iface.name).startsWith('tap') &&
        iface.ip_addresses &&
        iface.ip_addresses.length > 0
      );
      fillIfaceDropdown();
      renderSelectedInterfaces();
    } catch (e) {
      availableInterfaces = [];
      fillIfaceDropdown();
    }
  }

  async function refreshStatus(force) {
    if (isRefreshing && !force) return;
    isRefreshing = true;
    try {
      const result = await fetchJSON('/api/tls-interception/simple-status');
      if (result && result.success) {
        currentStatus = result.data || {};
        updateStatusUI(currentStatus);
      }
    } finally {
      isRefreshing = false;
    }
  }

  function normalizeConfig(cfg) {
    const out = { ...cfg };
    out.lan_interfaces = Array.isArray(out.lan_interfaces) ? out.lan_interfaces : (out.lan_interface ? [out.lan_interface] : []);
    out.intercept_ports = Array.isArray(out.intercept_ports) ? out.intercept_ports : derivePortsFromLegacy(out);

    // FIX: backend uses "excluded_urls"
    if (Array.isArray(out.excluded_urls)) out.excluded_urls = out.excluded_urls;
    else if (Array.isArray(out.exclude_urls)) out.excluded_urls = out.exclude_urls; // tolerate old key
    else out.excluded_urls = [];

    out.lan_interfaces = dedupeStrings(out.lan_interfaces);
    out.intercept_ports = dedupePorts(out.intercept_ports);
    out.excluded_urls = dedupeStrings(out.excluded_urls);
    return out;
  }

  function derivePortsFromLegacy(cfg) {
    const ports = [];
    if (cfg.intercept_http !== false) ports.push(80);
    if (cfg.intercept_https !== false) ports.push(443);
    return ports;
  }

  function renderAll() {
    fillIfaceDropdown();
    renderSelectedInterfaces();
    renderSelectedPorts();
    renderExcludes();
    updateStatusUI(currentStatus);
  }

  function fillIfaceDropdown() {
    const sel = document.getElementById('ifaceSelect');
    if (!sel) return;

    const selected = new Set((currentConfig.lan_interfaces || []).map(String));
    const options = availableInterfaces
      .filter(iface => !selected.has(String(iface.name)))
      .map(iface => {
        const displayName = iface.tag ? `${iface.tag} (${iface.name})` : iface.name;
        const ip = (iface.ip_addresses && iface.ip_addresses[0]) ? iface.ip_addresses[0] : '';
        return { value: iface.name, label: `${displayName} — ${ip}` };
      });

    sel.innerHTML = '';
    const placeholder = document.createElement('option');
    placeholder.value = '';
    placeholder.textContent = options.length ? 'Select an interface…' : 'No more interfaces available';
    sel.appendChild(placeholder);

    for (const opt of options) {
      const o = document.createElement('option');
      o.value = opt.value;
      o.textContent = opt.label;
      sel.appendChild(o);
    }
  }

  function renderSelectedInterfaces() {
    const wrap = document.getElementById('selectedInterfacesWrap');
    const empty = document.getElementById('noSelectedInterfaces');
    if (!wrap || !empty) return;

    const selected = currentConfig.lan_interfaces || [];
    wrap.innerHTML = '';

    if (selected.length === 0) {
      empty.style.display = 'block';
      return;
    }
    empty.style.display = 'none';

    for (const ifaceName of selected) {
      const iface = availableInterfaces.find(i => String(i.name) === String(ifaceName));
      const displayName = iface ? (iface.tag ? `${iface.tag} (${iface.name})` : iface.name) : ifaceName;
      const ip = iface?.ip_addresses?.[0] || '';

      const pill = document.createElement('span');
      pill.className = 'ti-pill';
      pill.innerHTML = `
      <i class="bi bi-ethernet text-primary"></i>
      <span><strong>${escapeHtml(displayName)}</strong>${ip ? ` <span class="ti-muted">— ${escapeHtml(ip)}</span>` : ''}</span>
      <button type="button" class="btn-close" aria-label="Remove"></button>
    `;
      pill.querySelector('.btn-close').addEventListener('click', () => removeInterface(ifaceName));
      wrap.appendChild(pill);
    }
  }

  function syncSubnetsFromSelectedInterfaces() {
    const subnets = [];

    for (const name of currentConfig.lan_interfaces) {
      const info = availableInterfaces.find(i => String(i.name) === String(name));
      const firstIp = info?.ip_addresses?.[0];

      if (firstIp) {
        subnets.push(getNetworkSubnet(firstIp));
      }
    }

    currentConfig.intercept_subnets = dedupeStrings(subnets);
  }

  function addSelectedInterface() {
    const sel = document.getElementById('ifaceSelect');
    const val = sel ? sel.value : '';
    if (!val) return showToast('Select an interface first', 'warning');

    currentConfig.lan_interfaces = dedupeStrings([...(currentConfig.lan_interfaces || []), val]);
    syncSubnetsFromSelectedInterfaces();

    setDirty(true);
    if (sel) sel.value = '';
    fillIfaceDropdown();
    renderSelectedInterfaces();
  }

  function removeInterface(name) {
    currentConfig.lan_interfaces = (currentConfig.lan_interfaces || []).filter(x => String(x) !== String(name));
    syncSubnetsFromSelectedInterfaces();

    setDirty(true);
    fillIfaceDropdown();
    renderSelectedInterfaces();
  }

  function renderSelectedPorts() {
    const wrap = document.getElementById('selectedPortsWrap');
    const empty = document.getElementById('noSelectedPorts');
    if (!wrap || !empty) return;

    const ports = (currentConfig.intercept_ports || []).slice().sort((a, b) => a - b);
    wrap.innerHTML = '';

    if (ports.length === 0) {
      empty.style.display = 'block';
      return;
    }
    empty.style.display = 'none';

    for (const p of ports) {
      const label = (p === 80) ? '80 (HTTP)' : (p === 443) ? '443 (HTTPS)' : String(p);
      const pill = document.createElement('span');
      pill.className = 'ti-pill';
      pill.innerHTML = `
      <i class="bi bi-plug text-info"></i>
      <span><strong>${escapeHtml(label)}</strong></span>
      <button type="button" class="btn-close" aria-label="Remove"></button>
    `;
      pill.querySelector('.btn-close').addEventListener('click', () => removePort(p));
      wrap.appendChild(pill);
    }
  }

  function quickAddPort(p) { addPort(p); }

  function addPortFromInput() {
    const input = document.getElementById('portInput');
    const p = parseInt(input?.value || '', 10);
    if (!Number.isFinite(p) || p < 1 || p > 65535) return showToast('Enter a valid port (1-65535)', 'warning');
    addPort(p);
    if (input) input.value = '';
  }

  function addPort(p) {
    currentConfig.intercept_ports = dedupePorts([...(currentConfig.intercept_ports || []), p]);
    setDirty(true);
    renderSelectedPorts();
  }

  function removePort(p) {
    currentConfig.intercept_ports = (currentConfig.intercept_ports || []).filter(x => Number(x) !== Number(p));
    setDirty(true);
    renderSelectedPorts();
  }

  function renderExcludes() {
    const wrap = document.getElementById('excludeWrap');
    const empty = document.getElementById('noExcludes');
    if (!wrap || !empty) return;

    const list = currentConfig.excluded_urls || [];
    wrap.innerHTML = '';

    if (list.length === 0) {
      empty.style.display = 'block';
      return;
    }
    empty.style.display = 'none';

    for (const s of list) {
      const pill = document.createElement('span');
      pill.className = 'ti-pill';
      pill.innerHTML = `
      <i class="bi bi-slash-circle text-danger"></i>
      <span><strong>${escapeHtml(s)}</strong></span>
      <button type="button" class="btn-close" aria-label="Remove"></button>
    `;
      pill.querySelector('.btn-close').addEventListener('click', () => removeExclude(s));
      wrap.appendChild(pill);
    }
  }

  function addExcludeFromInput() {
    const input = document.getElementById('excludeInput');
    const val = (input?.value || '').trim();
    if (!val) return showToast('Enter a pattern first', 'warning');
    addExclude(val);
    if (input) input.value = '';
  }

  function addExcludesFromBulk() {
    const ta = document.getElementById('excludeBulk');
    const raw = ta ? ta.value : '';
    const lines = raw.split('\n').map(x => x.trim()).filter(Boolean);
    if (lines.length === 0) return showToast('No lines to add', 'warning');

    let added = 0;
    for (const line of lines) if (addExclude(line, true)) added++;
    if (ta) ta.value = '';
    if (added > 0) showToast(`Added ${added} exclusion(s)`, 'success');
    renderExcludes();
  }

  function addExclude(s, silent = false) {
    const list = currentConfig.excluded_urls || [];
    if (list.includes(s)) return false;
    currentConfig.excluded_urls = dedupeStrings([...list, s]);
    setDirty(true);
    if (!silent) renderExcludes();
    return true;
  }

  function removeExclude(s) {
    currentConfig.excluded_urls = (currentConfig.excluded_urls || []).filter(x => String(x) !== String(s));
    setDirty(true);
    renderExcludes();
  }

  function setDirty(flag) {
    isDirty = !!flag;
    const badge = document.getElementById('dirtyBadge');
    const applyBtn = document.getElementById('applyBtn');
    if (badge) badge.style.display = isDirty ? 'inline-block' : 'none';
    if (applyBtn) applyBtn.disabled = !isDirty || isActionBusy;
  }

  async function saveConfig() {
    const ifaces = currentConfig.lan_interfaces || [];
    const ports = currentConfig.intercept_ports || [];

    if (ifaces.length === 0) return showToast('Select at least one interface', 'warning');
    if (ports.length === 0) return showToast('Add at least one port', 'warning');

    const applyBtn = document.getElementById('applyBtn');
    const oldHtml = applyBtn ? applyBtn.innerHTML : '';
    isActionBusy = true;
    if (applyBtn) {
      applyBtn.disabled = true;
      applyBtn.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span>Applying…`;
    }

    try {
      const derivedSubnets = ifaces.map(name => {
        const info = availableInterfaces.find(i => String(i.name) === String(name));
        const firstIp = info?.ip_addresses?.[0];
        return firstIp ? getNetworkSubnet(firstIp) : null;
      }).filter(Boolean);

      const payload = {
        ...currentConfig,
        lan_interfaces: dedupeStrings(ifaces),
        intercept_ports: dedupePorts(ports),
        excluded_urls: dedupeStrings(currentConfig.excluded_urls || []),
        intercept_subnets: dedupeStrings(derivedSubnets)
      };

      const res = await fetchJSON('/api/tls-interception/config', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (res && res.success) {
        currentConfig = normalizeConfig(res.data || payload);
        setDirty(false);
        showToast('Configuration applied successfully', 'success');
        await refreshStatus(true);
        fillIfaceDropdown();
        renderSelectedInterfaces();
        renderSelectedPorts();
        renderExcludes();
        return true;
      }
      showToast('Failed to apply: ' + (res?.error || 'unknown error'), 'danger');
      return false;
    } catch (e) {
      showToast('Failed to apply: ' + e.message, 'danger');
      return false;
    } finally {
      isActionBusy = false;
      if (applyBtn) {
        applyBtn.innerHTML = oldHtml;
        applyBtn.disabled = !isDirty;
      }
    }
  }

  async function toggleInspection() {
    if (isActionBusy) return;
    isActionBusy = true;

    const toggleBtn = document.getElementById('toggleBtn');
    const isEnabled = !!currentStatus.enabled;
    const endpoint = isEnabled ? '/api/tls-interception/disable' : '/api/tls-interception/enable';

    if (!isEnabled && isDirty) {
      const ok = await saveConfig();
      if (!ok) { isActionBusy = false; return; }
    }

    if (!isEnabled) {
      if ((currentConfig.lan_interfaces || []).length === 0) {
        showToast('Select at least one interface', 'warning');
        isActionBusy = false;
        return;
      }
      if ((currentConfig.intercept_ports || []).length === 0) {
        showToast('Add at least one port', 'warning');
        isActionBusy = false;
        return;
      }
    }

    const old = toggleBtn ? toggleBtn.innerHTML : '';
    if (toggleBtn) {
      toggleBtn.disabled = true;
      toggleBtn.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span>${isEnabled ? 'Disabling…' : 'Enabling…'}`;
    }

    try {
      const res = await fetchJSON(endpoint, { method: 'POST' });
      if (!res || !res.success) {
        showToast('Operation failed: ' + (res?.error || 'unknown error'), 'danger');
        await refreshStatus(true);
        return;
      }

      await waitForDesiredState(!isEnabled);
      showToast(isEnabled ? 'Inspection disabled' : 'Inspection enabled', 'success');
    } catch (e) {
      showToast('Operation failed: ' + e.message, 'danger');
    } finally {
      isActionBusy = false;
      if (toggleBtn) {
        toggleBtn.disabled = false;
        toggleBtn.innerHTML = old;
      }
      await refreshStatus(true);
      setDirty(isDirty);
    }
  }

  async function waitForDesiredState(shouldBeEnabled) {
    for (let i = 0; i < 10; i++) {
      await refreshStatus(true);
      if (!!currentStatus.enabled === !!shouldBeEnabled) return true;
      await sleep(400);
    }
    return false;
  }

  function updateStatusUI(status) {
    const toggleBtn = document.getElementById('toggleBtn');

    const enabled = !!status.enabled;
    const proxy = !!status.mitmproxy_running;
    const ports = Array.isArray(status.active_ports) ? status.active_ports : [];
    const ifaces = Array.isArray(status.attached_interfaces) ? status.attached_interfaces : [];

    if (toggleBtn && !isActionBusy) {
      if (enabled) {
        toggleBtn.className = 'btn btn-danger';
        toggleBtn.innerHTML = '<i class="bi bi-stop-circle me-1"></i> Disable Inspection';
      } else {
        toggleBtn.className = 'btn btn-success';
        toggleBtn.innerHTML = '<i class="bi bi-play-circle me-1"></i> Enable Inspection';
      }
    }

    const rtEnabled = document.getElementById('rtEnabled');
    const rtProxy = document.getElementById('rtProxy');
    const rtIfaces = document.getElementById('rtIfaces');
    const rtPorts = document.getElementById('rtPorts');

    if (rtEnabled) {
      rtEnabled.innerHTML = enabled
        ? '<span class="badge bg-success">Active</span>'
        : '<span class="badge bg-secondary">Disabled</span>';
    }

    if (rtProxy) {
      rtProxy.innerHTML = proxy
        ? '<span class="badge bg-success">Running</span>'
        : '<span class="badge bg-danger">Stopped</span>';
    }

    if (rtIfaces) {
      rtIfaces.textContent = ifaces.length ? ifaces.join(', ') : 'None';
    }

    if (rtPorts) {
      rtPorts.textContent = ports.length ? ports.join(', ') : 'None';
    }

    const warn = document.getElementById('runtimeWarning');
    const warnText = document.getElementById('runtimeWarningText');
    let msg = '';
    if (enabled && !proxy) msg = 'Proxy service is not running. Traffic may not be inspected.';
    if (status.error_message) msg = status.error_message;

    if (warn && warnText) {
      if (msg) {
        warnText.textContent = msg;
        warn.style.display = 'block';
      } else {
        warn.style.display = 'none';
      }
    }
  }

  // ---- CA upload ----
  async function loadCertInfo(showErrors) {
    try {
      const res = await fetchJSON('/api/tls-interception/certificates');
      if (!res || !res.success) {
        if (showErrors) showToast('Failed to load certificate info', 'danger');
        return;
      }
      const info = res.data || {};
      const badge = document.getElementById('caStatusBadge');
      const ok = !!info.ca_bundle_exists || !!info.ca_key_exists;
      if (badge) {
        badge.className = 'badge ' + (ok ? 'bg-success' : 'bg-secondary');
        badge.textContent = ok ? 'Installed' : 'Not Found';
      }
    } catch (e) {
      if (showErrors) showToast('Failed to load certificate info: ' + e.message, 'danger');
    }
  }

  async function uploadCA() {
    const input = document.getElementById('caFile');
    const btn = document.getElementById('uploadCaBtn');
    const file = input?.files?.[0];
    if (!file) return showToast('Choose a PEM file first', 'warning');

    if (file.size > 10 * 1024 * 1024) return showToast('File too large (max 10MB)', 'warning');

    const old = btn ? btn.innerHTML : '';
    if (btn) {
      btn.disabled = true;
      btn.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span>Uploading…`;
    }

    try {
      const fd = new FormData();
      fd.append('certificate', file);

      const r = await fetch('/api/tls-interception/certificates/upload', { method: 'POST', body: fd });
      const text = await r.text();
      let res;
      try { res = JSON.parse(text); } catch { res = { success: false, error: text }; }

      if (res && res.success) {
        showToast('CA certificate uploaded successfully', 'success');
        if (input) input.value = '';
        await loadCertInfo(true);
      } else {
        showToast('Upload failed: ' + (res?.error || 'unknown error'), 'danger');
      }
    } catch (e) {
      showToast('Upload failed: ' + e.message, 'danger');
    } finally {
      if (btn) {
        btn.disabled = false;
        btn.innerHTML = old;
      }
    }
  }

  // helpers
  async function fetchJSON(url, options) {
    const r = await fetch(url, options);
    const text = await r.text();
    try { return JSON.parse(text); } catch { return text; }
  }

  function dedupeStrings(arr) {
    const out = [];
    const seen = new Set();
    for (const x of (arr || [])) {
      const s = String(x).trim();
      if (!s) continue;
      if (seen.has(s)) continue;
      seen.add(s);
      out.push(s);
    }
    return out;
  }

  function dedupePorts(arr) {
    const out = [];
    const seen = new Set();
    for (const x of (arr || [])) {
      const n = Number(x);
      if (!Number.isFinite(n)) continue;
      const p = Math.floor(n);
      if (p < 1 || p > 65535) continue;
      if (seen.has(p)) continue;
      seen.add(p);
      out.push(p);
    }
    return out;
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text == null ? '' : String(text);
    return div.innerHTML;
  }

  function showToast(message, type) {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} position-fixed bottom-0 end-0 m-3 shadow`;
    toast.style.zIndex = '9999';
    toast.style.maxWidth = '400px';
    toast.style.fontSize = '0.875rem';
    toast.innerHTML = `<div class="d-flex align-items-start gap-2">
    <div>${escapeHtml(message)}</div>
    <button type="button" class="btn-close" aria-label="Close"></button>
  </div>`;
    toast.querySelector('.btn-close').addEventListener('click', () => toast.remove());
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 4000);
  }

  function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }
</script>
{{ end }}