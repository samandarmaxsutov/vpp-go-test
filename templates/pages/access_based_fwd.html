{{ template "base" . }}
{{ define "abf_page" }}

<div class="container-fluid">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">ABF (ACL-based Forwarding) Boshqaruvi</h1>
    </div>

    <div class="row">
        <div class="col-md-5">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <i class="bi bi-plus-circle me-2"></i> Yangi ABF Policy Yaratish
                </div>
                <div class="card-body">
                    <form id="abfPolicyForm">
                        <div class="mb-3">
                            <label class="form-label">Policy ID</label>
                            <input type="number" class="form-control" id="policy_id" min="1" placeholder="Masalan: 1" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ACL</label>
                            <select class="form-select" id="acl_select" required>
                                <option value="">ACL tanlang...</option>
                            </select>
                            <small class="text-muted">ACL index: <span id="selected_acl_index">-</span></small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Next-Hop IP</label>
                            <input type="text" class="form-control" id="next_hop" placeholder="10.0.0.1" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Policy Saqlash</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-7">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-success text-white">
                    <i class="bi bi-link-45deg me-2"></i> Interfeysga biriktirish (Attach)
                </div>
                <div class="card-body">
                    <form id="abfAttachForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Policy ID</label>
                                <select class="form-select" id="attach_policy_id" required>
                                    <option value="">Policy tanlang...</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Interfeys</label>
                                <select class="form-select" id="sw_if_index_select" required>
                                    <option value="">Interfeysni tanlang...</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Ustuvorlik (Priority)</label>
                                <input type="number" class="form-control" id="priority" value="10" required>
                            </div>
                            <div class="col-md-6 mb-3 d-flex align-items-end">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="is_ipv6">
                                    <label class="form-check-label">IPv6 rejim</label>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success w-100">Interfeysga bog'lash</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-7">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-dark text-white d-flex justify-content-between">
                    <span><i class="bi bi-list-ul me-2"></i> Siyosatlar</span>
                    <button class="btn btn-sm btn-outline-light" onclick="loadAbfPolicies()"><i class="bi bi-arrow-clockwise"></i></button>
                </div>
                <div class="card-body p-0">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>ACL</th>
                                <th>Next-Hop</th>
                                <th>Amal</th>
                            </tr>
                        </thead>
                        <tbody id="abfTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-md-5">
            <div class="card shadow-sm">
                <div class="card-header bg-secondary text-white d-flex justify-content-between">
                    <span><i class="bi bi-intersect me-2"></i> Faol Biriktirmalar</span>
                    <button class="btn btn-sm btn-outline-light" onclick="loadAbfAttachments()"><i class="bi bi-arrow-clockwise"></i></button>
                </div>
                <div class="card-body p-0">
                    <table class="table table-sm table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Policy</th>
                                <th>Interfeys</th>
                                <th>Priority</th>
                                <th>Amal</th>
                            </tr>
                        </thead>
                        <tbody id="attachTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Global cache for interfaces and ACLs
    let interfacesCache = [];
    let aclsCache = [];
    let policiesCache = [];

    // Sahifa yuklanganda barcha ma'lumotlarni olish
    window.onload = function() {
        loadInterfaces();
        loadACLs();
        loadAbfPolicies();
        loadAbfAttachments();
    };

    // 1. Interfeyslarni yuklash (enriched data)
    async function loadInterfaces() {
        try {
            const res = await fetch('/api/abf/interfaces');
            interfacesCache = await res.json();
            const select = document.getElementById('sw_if_index_select');
            select.innerHTML = '<option value="">Interfeysni tanlang...</option>';
            
            interfacesCache.forEach(i => {
                const opt = document.createElement('option');
                opt.value = i.index;
                opt.text = i.display_name;
                opt.title = `Name: ${i.name}, Tag: ${i.tag || '-'}, IPs: ${i.ip_addresses.join(', ') || '-'}`;
                select.add(opt);
            });
        } catch (err) {
            console.error('Interfaces loading error:', err);
        }
    }

    // 2. ACL larni yuklash
    async function loadACLs() {
        try {
            const res = await fetch('/api/acl');
            aclsCache = await res.json();
            const select = document.getElementById('acl_select');
            select.innerHTML = '<option value="">ACL tanlang...</option>';
            
            aclsCache.forEach(acl => {
                const opt = document.createElement('option');
                opt.value = acl.acl_index;
                opt.text = acl.tag ? `${acl.tag} (ID: ${acl.acl_index})` : `ACL-${acl.acl_index}`;
                select.add(opt);
            });

            // Update selected ACL index display
            select.addEventListener('change', function() {
                document.getElementById('selected_acl_index').textContent = this.value || '-';
            });
        } catch (err) {
            console.error('ACL loading error:', err);
        }
    }

    // 3. Policy Yaratish
    document.getElementById('abfPolicyForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const data = {
            policy_id: parseInt(document.getElementById('policy_id').value),
            acl_index: parseInt(document.getElementById('acl_select').value),
            next_hop: document.getElementById('next_hop').value.trim(),
            is_add: true
        };
        const res = await fetch('/api/abf/policy', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        const result = await res.json();
        alert(result.message || result.error);
        loadAbfPolicies();
    });

    // 4. Attach (Biriktirish)
    document.getElementById('abfAttachForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const data = {
            policy_id: parseInt(document.getElementById('attach_policy_id').value),
            sw_if_index: parseInt(document.getElementById('sw_if_index_select').value),
            priority: parseInt(document.getElementById('priority').value),
            is_ipv6: document.getElementById('is_ipv6').checked,
            is_add: true
        };
        const res = await fetch('/api/abf/attach', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        const result = await res.json();
        alert(result.message || result.error);
        loadAbfAttachments();
    });

    // 5. Policy Ro'yxatini yuklash (enriched with ACL names)
    async function loadAbfPolicies() {
        try {
            const res = await fetch('/api/abf/policies');
            policiesCache = await res.json();
            const tbody = document.getElementById('abfTableBody');
            tbody.innerHTML = '';
            
            // Update policy dropdown
            const policySelect = document.getElementById('attach_policy_id');
            policySelect.innerHTML = '<option value="">Policy tanlang...</option>';

            if(!policiesCache || policiesCache.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Hech qanday policy topilmadi</td></tr>';
                return;
            }

            policiesCache.forEach(p => {
                const pId = p.policy_id;
                const aclTag = p.acl_tag || `ACL-${p.acl_index}`;
                const nextHops = p.next_hops ? p.next_hops.join(', ') : '-';

                tbody.innerHTML += `
                    <tr>
                        <td><strong>${pId}</strong></td>
                        <td>
                            <span class="badge bg-info">${aclTag}</span>
                            <small class="text-muted d-block">Index: ${p.acl_index}</small>
                        </td>
                        <td><code>${nextHops}</code></td>
                        <td>
                            <button class="btn btn-danger btn-sm" onclick="deletePolicy(${pId}, ${p.acl_index}, '${p.next_hops ? p.next_hops[0] : '0.0.0.0'}')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>`;

                // Add to dropdown
                const opt = document.createElement('option');
                opt.value = pId;
                opt.text = `Policy ${pId} (${aclTag})`;
                policySelect.add(opt);
            });
        } catch (err) {
            console.error('Policies loading error:', err);
        }
    }

    // 6. Attachment Ro'yxatini yuklash (enriched with interface info)
    async function loadAbfAttachments() {
        try {
            const res = await fetch('/api/abf/attachments');
            const attaches = await res.json();
            const tbody = document.getElementById('attachTableBody');
            tbody.innerHTML = '';

            if(!attaches || attaches.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Hech qanday biriktirma topilmadi</td></tr>';
                return;
            }

            attaches.forEach(a => {
                // Build interface display
                let ifaceDisplay = a.interface_name || `Idx: ${a.sw_if_index}`;
                if (a.interface_tag && a.interface_tag !== a.interface_name) {
                    ifaceDisplay = `${a.interface_name} <small class="text-muted">(${a.interface_tag})</small>`;
                }
                if (a.interface_ip) {
                    ifaceDisplay += `<br><small class="text-success">${a.interface_ip}</small>`;
                }

                tbody.innerHTML += `
                    <tr>
                        <td><strong>${a.policy_id}</strong></td>
                        <td>${ifaceDisplay}</td>
                        <td><span class="badge bg-secondary">${a.priority}</span></td>
                        <td>
                            <button class="btn btn-warning btn-sm" onclick="detachInterface(${a.policy_id}, ${a.sw_if_index}, ${a.priority})">
                                <i class="bi bi-link-45deg"></i> Uzish
                            </button>
                        </td>
                    </tr>`;
            });
        } catch (err) {
            console.error('Attachments loading error:', err);
        }
    }

    // 7. Detach (Interfeysdan uzish)
    async function detachInterface(pId, swIdx, priority) {
        if(!confirm("Ushbu interfeysdan siyosatni uzasizmi?")) return;
        const data = {
            policy_id: pId,
            sw_if_index: swIdx,
            priority: priority,
            is_add: false
        };
        const res = await fetch('/api/abf/attach', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        const result = await res.json();
        alert(result.message || "Uzildi");
        loadAbfAttachments();
    }

    // 8. Policy o'chirish
    async function deletePolicy(pId, aIdx, ip) {
        if(!confirm("Policy o'chirilsinmi? (Eslatma: Avval interfeysdan uzing!)")) return;
        const data = { policy_id: pId, acl_index: aIdx, next_hop: ip, is_add: false };
        const res = await fetch('/api/abf/policy', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        const result = await res.json();
        alert(result.message || "O'chirildi");
        loadAbfPolicies();
    }

    // Helper: Get interface name by index from cache
    function getInterfaceName(idx) {
        const iface = interfacesCache.find(i => i.index === idx);
        if (iface) {
            return iface.tag || iface.name;
        }
        return `Idx: ${idx}`;
    }
</script>
{{ end }}