{{ template "base" . }}
{{ define "interfaces_page" }}

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h4 class="fw-bold mb-0 text-primary">
            <i class="bi bi-ethernet me-2"></i>Network Interfaces
        </h4>
        <small class="text-muted">WAN / LAN / VLAN / Vmxnet3 / Virtual Management</small>
    </div>
    <div class="btn-group shadow-sm">
        <button class="btn btn-dark fw-bold" onclick="openVmxnetModal()">
            <i class="bi bi-cpu-fill me-1"></i>+ Vmxnet3
        </button>
        <button class="btn btn-outline-warning fw-bold" onclick="openVlanModal()">
            <i class="bi bi-diagram-3 me-1"></i>+ VLAN
        </button>
        <button class="btn btn-outline-primary fw-bold" onclick="addLoopback()">
            <i class="bi bi-arrow-repeat me-1"></i>+ Loopback
        </button>
        <button class="btn btn-primary fw-bold" onclick="openVhostModal()">
            <i class="bi bi-cpu me-1"></i>+ Vhost
        </button>
        <button class="btn btn-outline-info fw-bold" onclick="openTapModal()">
            <i class="bi bi-patch-plus me-1"></i>+ TAP
        </button>
    </div>
</div>

<div id="interfaces-container"></div>

{{ template "ip_modal" . }}

<div class="modal fade" id="vmxnetModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow-lg border-0">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title fw-bold"><i class="bi bi-cpu-fill me-2"></i>Create Vmxnet3 Interface</h5>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="fw-bold small mb-1">Available PCI Devices (Vmxnet3)</label>
                    <select id="vmxPciSelect" class="form-select shadow-sm border-primary">
                        <option value="">Scanning for devices...</option>
                    </select>
                    <div id="pciStatusMsg" class="small mt-1 text-muted"></div>
                </div>
                <div class="row">
                    <div class="col-6">
                        <label class="fw-bold small mb-1">Rx Queue Size</label>
                        <select id="vmxRx" class="form-select small">
                            <option value="512">512</option>
                            <option value="1024" selected>1024</option>
                            <option value="2048">2048</option>
                        </select>
                    </div>
                    <div class="col-6">
                        <label class="fw-bold small mb-1">Tx Queue Size</label>
                        <select id="vmxTx" class="form-select small">
                            <option value="512">512</option>
                            <option value="1024" selected>1024</option>
                            <option value="2048">2048</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer bg-light">
                <button class="btn btn-dark w-100 fw-bold py-2" id="btnSubmitVmx" onclick="submitVmxnet()" disabled>
                    <i class="bi bi-plus-circle me-1"></i> Bind Interface to VPP
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="vlanModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow-lg border-0">
            <div class="modal-header bg-warning">
                <h5 class="modal-title fw-bold">Create VLAN</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <label class="fw-bold">Parent Interface</label>
                <select id="vlanParent" class="form-select mb-3"></select>
                <label class="fw-bold">VLAN ID</label>
                <input type="number" id="vlanId" class="form-control" placeholder="100">
            </div>
            <div class="modal-footer">
                <button class="btn btn-warning w-100 fw-bold" onclick="submitVlan()">Create</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="vhostModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow-lg border-0">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title fw-bold">Create Vhost-User</h5>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <label class="fw-bold">Socket Path</label>
                <input id="vhostSocket" class="form-control mb-3" placeholder="/run/sarhad/vhost.sock">

                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="vhostServer" checked>
                    <label class="form-check-label fw-bold">Server Mode</label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary w-100 fw-bold" onclick="submitVhost()">Create</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="tapModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow-lg border-0">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title fw-bold">Create TAP</h5>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <label class="fw-bold">Host Interface Name</label>
                <input id="tapHost" class="form-control" placeholder="tap0">
            </div>
            <div class="modal-footer">
                <button class="btn btn-info text-white w-100 fw-bold" onclick="submitTap()">Create</button>
            </div>
        </div>
    </div>
</div>


<style>
    .group-header {
        margin: 30px 0 15px;
        padding-left: 10px;
        border-left: 4px solid #0d6efd;
        font-weight: bold;
    }

    .badge-ip {
        background: #e7f1ff;
        border: 1px solid #cfe2ff;
        color: #0d6efd;
    }

    .editable-tag,
    .editable-mac {
        cursor: pointer;
    }

    .pulse-animation {
        animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
        0% {
            opacity: 1
        }

        50% {
            opacity: .4
        }

        100% {
            opacity: 1
        }
    }
</style>

<script>

    /* ----------------- HELPERS ----------------- */
    const postJSON = async (url, data) => {
        const res = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        if (res.status === 403) {
            const err = await res.json();
            alert(err.error || "Permission denied");
            throw new Error("Forbidden");
        }
        return res;
    };

    const tagColors = {
        WAN: 'danger',
        LAN: 'success',
        OTHER: 'secondary'
    };


    const getTagGroup = iface => {
        if (!iface.tag) return 'OTHER';
        const t = iface.tag.toLowerCase();
        if (t.includes('wan')) return 'WAN';
        if (t.includes('lan')) return 'LAN';
        return 'OTHER';
    };

    const getTypeGroup = iface => {
        const n = iface.name.toLowerCase();
        if (n.includes('.')) return 'VLAN';
        if (n.includes('loop')) return 'LOOPBACK';
        if (n.includes('vmxnet3')) return 'VMXNET3'; // Vmxnet3 guruhi qo'shildi
        if (n.includes('tap') || n.includes('vhost')) return 'KERNEL';
        return 'PHYSICAL';
    };

    /* ----------------- LOAD INTERFACES ----------------- */
    window.loadInterfaces = async () => {
        try {
            const res = await fetch('/api/interfaces');
            const data = await res.json();
            const container = document.getElementById('interfaces-container');

            const tree = {};
            data.forEach(i => {
                const tag = getTagGroup(i);
                const type = getTypeGroup(i);
                tree[tag] ??= {};
                tree[tag][type] ??= [];
                tree[tag][type].push(i);
            });

            let html = '';

            for (const [tag, types] of Object.entries(tree)) {
                html += `<div class="group-header text-primary"><i class="bi bi-folder2-open me-2"></i>${tag}</div>`;

                for (const [type, items] of Object.entries(types)) {
                    html += `
                <div class="card shadow-sm mb-4 border-0">
                    <div class="card-header fw-bold bg-light py-2 small text-secondary d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-layers me-1"></i> ${type}</span>
                        <span class="badge bg-secondary opacity-50">${items.length}</span>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0 table-sm">
                                <thead class="table-light small text-muted">
                                    <tr>
                                        <th class="ps-3" width="110">STATUS</th>
                                        <th width="180">INTERFACE</th>
                                        <th width="120">TAG</th>
                                        <th width="160">MAC ADDRESS</th>
                                        <th width="110">IP MODE</th>
                                        <th>IP ADDRESSES</th>
                                        <th class="text-end pe-3">ACTIONS</th>
                                    </tr>
                                </thead>
                                <tbody>`;

                    items.forEach(iface => {
                        const ips = iface.ip_addresses?.filter(i => !i.startsWith('0.0.0.0')) || [];
                        const isUp = iface.status === 'UP';
                        const isDHCP = iface.is_dhcp;

                        html += `
                    <tr>
                        <td class="ps-3">
                            <div class="form-check form-switch d-flex align-items-center gap-2">
                                <input class="form-check-input ms-0 shadow-none" type="checkbox" style="width: 2.2em; height: 1.1em; cursor:pointer;"
                                    ${isUp ? 'checked':''}
                                    onchange="toggleStatus(${iface.index}, '${iface.status}')">
                                <span class="badge ${isUp ? 'bg-success' : 'bg-danger'} rounded-pill" style="font-size: 0.6rem; min-width:35px;">${iface.status}</span>
                            </div>
                        </td>
                        <td>
                            <div class="fw-bold text-dark d-flex align-items-center" style="font-size: 0.85rem;">
                                ${iface.name.includes('.') ? '<i class="bi bi-arrow-return-right me-1 text-muted"></i>' : '<i class="bi bi-pci-card me-2 text-secondary"></i>'}${iface.name}
                            </div>
                        </td>
                        <td>
                            <span class="editable-tag badge bg-light text-${tagColors[tag] || 'secondary'} border" 
                                onclick="editTag(${iface.index}, '${iface.tag||''}')" style="cursor:pointer;">
                                <i class="bi bi-tag-fill me-1"></i>${iface.tag || 'none'}
                            </span>
                        </td>
                        <td>
                            <code class="editable-mac text-muted small" onclick="editMac(${iface.index}, '${iface.mac}')" style="cursor:pointer; font-size:0.75rem;">
                                ${iface.mac}
                            </code>
                        </td>
                        <td>
                            <div class="form-check form-switch d-flex align-items-center gap-1">
                                <input class="form-check-input shadow-none" type="checkbox" style="width: 1.8em; height: 0.9em; cursor:pointer;"
                                    ${isDHCP ? 'checked' : ''} 
                                    onchange="toggleDHCP(${iface.index}, this.checked)">
                                <span class="small fw-bold ${isDHCP ? 'text-primary' : 'text-secondary'}" style="font-size: 0.7rem;">${isDHCP ? 'DHCP' : 'STAT'}</span>
                            </div>
                        </td>
                        <td>
                            <div class="d-flex flex-wrap gap-1">
                                ${ips.map(ip => {
                                    const ipClass = isDHCP ? 'bg-primary-subtle text-primary border-primary' : 'bg-info-subtle text-dark border-info';
                                    const ipIcon = isDHCP ? 'bi-cloud-check' : 'bi-shield-lock';
                                    return `
                                    <span class="badge ${ipClass} border d-flex align-items-center gap-1 py-1 px-2" style="font-size: 0.75rem; font-weight:500;">
                                        <i class="bi ${ipIcon}"></i>
                                        ${ip}
                                        ${!isDHCP ? `<i class="bi bi-x text-danger ms-1" style="cursor:pointer; font-size:0.9rem;" onclick="removeIp(${iface.index}, '${ip}')"></i>` : ''}
                                    </span>`;
                                }).join('')}
                                
                                ${isDHCP && ips.length === 0
                                    ? '<span class="badge bg-warning-subtle text-warning border border-warning pulse-animation small py-1 px-2"><i class="bi bi-arrow-repeat me-1"></i>Discovering...</span>'
                                    : ''}
                                ${!isDHCP && ips.length === 0 ? '<span class="text-muted" style="font-size:0.7rem; font-style:italic;">No IP set</span>' : ''}
                            </div>
                        </td>
                        <td class="text-end pe-3">
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary border-0 shadow-none" onclick="openIpModal(${iface.index})" title="Add IP">
                                    <i class="bi bi-plus-square"></i>
                                </button>
                                <button class="btn btn-outline-danger border-0 shadow-none" onclick="deleteInterface(${iface.index}, '${iface.name}')" title="Delete">
                                    <i class="bi bi-trash3"></i>
                                </button>
                            </div>
                        </td>
                    </tr>`;
                    });

                    html += `</tbody></table></div></div></div>`;
                }
            }

            container.innerHTML = html || '<div class="alert alert-light border text-center py-4">No network interfaces found.</div>';
        } catch (error) {
            console.error("Critical: Interface load failed", error);
        }
    };

    /* ----------------- ACTIONS ----------------- */
    window.toggleStatus = async (i, s) => {
        await postJSON('/api/interfaces/state', {
            index: i,
            is_up: s === 'DOWN'
        });
        loadInterfaces();
    }
    window.toggleDHCP = async (i, e) => {
        await postJSON('/api/interfaces/dhcp', {
            index: i,
            enable: e
        });
        await loadInterfaces();
        if (e) {
            let attempts = 0;
            const checkInterval = setInterval(async () => {
                attempts++;
                const res = await fetch('/api/interfaces');
                const data = await res.json();
                const iface = data.find(item => item.index === i);
                const hasIP = iface?.ip_addresses?.some(ip => !ip.startsWith('0.0.0.0'));
                if (hasIP || attempts > 5) {
                    clearInterval(checkInterval);
                    loadInterfaces();
                } else {
                    loadInterfaces();
                }
            }, 2000);
        }
    };
    window.editTag = async (i, c) => {
        const t = prompt('Tag:', c);
        if (t !== null) {
            await postJSON('/api/interfaces/tag', {
                index: i,
                tag: t
            });
            loadInterfaces();
        }
    }
    window.editMac = async (i, c) => {
        const m = prompt('MAC:', c);
        if (m) {
            await postJSON('/api/interfaces/mac', {
                index: i,
                mac: m
            });
            loadInterfaces();
        }
    }
    window.openIpModal = i => {
        modalIdx.value = i;
        new bootstrap.Modal(ipModal).show();
    }
    window.submitIp = async () => {
        await postJSON('/api/interfaces/add-ip', {
            index: +modalIdx.value,
            ip: newIpAddr.value
        });
        bootstrap.Modal.getInstance(ipModal).hide();
        loadInterfaces();
    }
    window.removeIp = async (i, ip) => {
        if (confirm(ip)) {
            await postJSON('/api/interfaces/remove-ip', {
                index: i,
                ip
            });
            loadInterfaces();
        }
    }

    // DeleteInterface yangilandi: Vmxnet3 uchun alohida endpoint chaqiradi
    window.deleteInterface = async (i, n) => {
        if (confirm(`${n} interfeysini o'chirmoqchimisiz?`)) {
            const url = n.toLowerCase().includes('vmxnet3') ? '/api/interfaces/vmxnet3/delete' : '/api/interfaces/delete';
            await postJSON(url, {
                index: i,
                name: n
            });
            loadInterfaces();
        }
    }

    window.addLoopback = async () => {
        await postJSON('/api/interfaces/create-loopback', {});
        loadInterfaces();
    }

    /* ----------------- VLAN ----------------- */
    window.openVlanModal = async () => {
        const res = await fetch('/api/interfaces');
        const data = await res.json();
        vlanParent.innerHTML = data
            .filter(i => !i.name.includes('.'))
            .map(i => `<option value="${i.index}">${i.name}</option>`).join('');
        new bootstrap.Modal(vlanModal).show();
    };
    window.submitVlan = async () => {
        await postJSON('/api/create/vlan', {
            parent_index: +vlanParent.value,
            vlan_id: +vlanId.value
        });
        bootstrap.Modal.getInstance(vlanModal).hide();
        loadInterfaces();
    };

    /* -------- VHOST -------- */
    window.openVhostModal = () => {
        new bootstrap.Modal(document.getElementById('vhostModal')).show();
    };
    window.submitVhost = async () => {
        const res = await postJSON('/api/interfaces/create-vhost', {
            socket_file: vhostSocket.value,
            is_server: vhostServer.checked
        });
        if (res.ok) {
            bootstrap.Modal.getInstance(vhostModal).hide();
            loadInterfaces();
        } else alert("Vhost yaratilmadi!");
    };

    /* -------- TAP -------- */
    window.openTapModal = () => {
        new bootstrap.Modal(document.getElementById('tapModal')).show();
    };
    window.submitTap = async () => {
        const res = await postJSON('/api/interfaces/create-tap', {
            host_name: tapHost.value
        });
        if (res.ok) {
            bootstrap.Modal.getInstance(tapModal).hide();
            loadInterfaces();
        } else alert("TAP yaratilmadi!");
    };

    /* -------- VMXNET3 -------- */
    window.openVmxnetModal = async () => {
        const select = document.getElementById('vmxPciSelect');
        const btn = document.getElementById('btnSubmitVmx');
        const msg = document.getElementById('pciStatusMsg');
        const modal = new bootstrap.Modal(document.getElementById('vmxnetModal'));

        select.innerHTML = '<option value="">Scanning PCI bus...</option>';
        btn.disabled = true;
        modal.show();

        try {
            // Backenddagi skanerlash API-ni chaqiramiz
            const res = await fetch('/api/pci');
            const devices = await res.json();

            if (!devices || devices.length === 0) {
                select.innerHTML = '<option value="">No available Vmxnet3 cards found</option>';
                msg.innerHTML = '<span class="text-danger"><i class="bi bi-exclamation-triangle"></i> All Vmxnet3 adapters are already bound or missing.</span>';
                return;
            }

            // Dropdownni to'ldiramiz
            select.innerHTML = devices.map(d => `
            <option value="${d.pci_addr}">
                ${d.pci_addr} - ${d.description}
            </option>
        `).join('');

            btn.disabled = false;
            msg.innerHTML = `<span class="text-success"><i class="bi bi-check-circle"></i> Found ${devices.length} available device(s).</span>`;

        } catch (error) {
            console.error("PCI Scan failed", error);
            select.innerHTML = '<option value="">Error scanning PCI bus</option>';
            msg.innerHTML = '<span class="text-danger">Failed to connect to backend.</span>';
        }
    };

    window.submitVmxnet = async () => {
        const pciAddr = document.getElementById('vmxPciSelect').value;
        const rx = document.getElementById('vmxRx').value;
        const tx = document.getElementById('vmxTx').value;
        const btn = document.getElementById('btnSubmitVmx');

        if (!pciAddr) return alert("Please select a PCI device!");

        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Binding...';
        btn.disabled = true;

        const res = await postJSON('/api/interfaces/vmxnet3/create', {
            pci_addr: pciAddr,
            rx_size: parseInt(rx),
            tx_size: parseInt(tx)
        });

        if (res.ok) {
            bootstrap.Modal.getInstance(document.getElementById('vmxnetModal')).hide();
            loadInterfaces();
        } else {
            const err = await res.json();
            alert("Vmxnet3 creation failed: " + (err.error || "Unknown VPP error"));
        }

        btn.innerHTML = '<i class="bi bi-plus-circle me-1"></i> Bind Interface to VPP';
        btn.disabled = false;
    };

    /* ----------------- INIT ----------------- */
    document.addEventListener('DOMContentLoaded', loadInterfaces);
</script>

{{ end }}