{{ template "base" . }}
{{ define "interfaces_page" }}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="fw-bold">Interfaces</h4>
    <button class="btn btn-primary" onclick="addLoopback()">+ Add Loopback</button>
</div>

<div class="card shadow-sm border-0">
    <div class="card-body p-0">
        <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
                <tr>
                    <th class="ps-3">Status</th>
                    <th>Name</th>
                    <th>DHCP</th>
                    <th>IP Addresses</th>
                    <th class="text-end pe-3">Actions</th>
                </tr>
            </thead>
            <tbody id="if-tbody"></tbody>
        </table>
    </div>
</div>

{{ template "ip_modal" . }}

<script>

    // 1. Interface
    window.loadInterfaces = async () => {
        try {
            const res = await fetch('/api/interfaces');
            if (!res.ok) throw new Error("Ma'lumotlarni yuklab bo'lmadi");

            const data = await res.json();
            const tbody = document.getElementById('if-tbody');
            if (!tbody) return;

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center p-4 text-muted">Interfeyslar mavjud emas</td></tr>';
                return;
            }

            tbody.innerHTML = data.map(iface => {
                // 1. DHCP holati (backenddan kelgan bayroq)
                const isDHCPActive = iface.is_dhcp;

                // 2. Haqiqiy IP manzillar (0.0.0.0 ni chiqarib tashlaymiz)
                const displayIPs = iface.ip_addresses ? iface.ip_addresses.filter(ip => !ip.startsWith("0.0.0.0")) : [];

                // 3. DHCP yoniq lekin IP hali kelmagan bo'lsa
                const isSearching = isDHCPActive && displayIPs.length === 0;

                return `
            <tr>
                <td class="ps-3">
                    <div class="form-check form-switch d-flex align-items-center gap-2">
                        <input class="form-check-input" type="checkbox" 
                            ${iface.status === 'UP' ? 'checked' : ''} 
                            onchange="toggleStatus(${iface.index}, '${iface.status}')">
                        <span class="badge ${iface.status === 'UP' ? 'bg-success' : 'bg-danger'}">
                            ${iface.status}
                        </span>
                    </div>
                </td>
                <td>
                    <div class="fw-bold">${iface.name}</div>
                    <small class="text-muted" style="font-family: monospace;">
                        ${iface.mac}
                    </small>
                </td>
                <td>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" 
                            ${isDHCPActive ? 'checked' : ''}
                            onchange="toggleDHCP(${iface.index}, this.checked)">
                        <label class="small ${isDHCPActive ? 'text-primary fw-bold' : 'text-muted'}">
                            ${isDHCPActive ? 'DHCP ON' : 'Static'}
                        </label>
                    </div>
                </td>
                <td>
                    <div id="ip-list-${iface.index}" class="d-flex flex-wrap gap-1">
                        ${displayIPs.length > 0 ? displayIPs.map(ip => `
                            <span class="badge ${isDHCPActive ? 'bg-success' : 'bg-info'} d-flex align-items-center gap-1 shadow-sm px-2">
                                <i class="bi ${isDHCPActive ? 'bi-cloud-download' : 'bi-shield-lock'}"></i>
                                ${ip}
                                ${!isDHCPActive ? `
                                    <i class="bi bi-x-circle-fill text-white-50 ms-1" 
                                       style="cursor:pointer; font-size: 0.9rem;" 
                                       onclick="removeIp(${iface.index}, '${ip}')"></i>
                                ` : ''}
                            </span>`).join('')
                        : (isSearching ?
                            `<span class="badge bg-warning text-dark border shadow-sm pulse-animation d-flex align-items-center gap-1">
                                <span class="spinner-border spinner-border-sm" role="status"></span>
                                Searching...
                             </span>`
                            : '<small class="text-muted">No IP Assigned</small>')}
                    </div>
                </td>
                <td class="text-end pe-3">
                    <div class="btn-group shadow-sm">
                        <button class="btn btn-sm btn-outline-primary" onclick="openIpModal(${iface.index})" title="Add IP">
                            <i class="bi bi-plus-lg"></i> IP
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteInterface(${iface.index})" title="Delete Interface">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>`;
            }).join('');

        } catch (err) {
            console.error("Xato:", err);
            const tbody = document.getElementById('if-tbody');
            if (tbody) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center text-danger p-3">Xato: ${err.message}</td></tr>`;
            }
        }
    };

    // 2. Statusni o'zgartirish (UP/DOWN)
    window.toggleStatus = async (index, currentStatus) => {
        const isUp = currentStatus === 'DOWN';
        await fetch('/api/interfaces/state', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ index: parseInt(index), is_up: isUp })
        });
        window.loadInterfaces();
    };

    // 3. DHCPni yoqish/o'chirish
    window.toggleDHCP = async (index, isChecked) => {
        await fetch('/api/interfaces/dhcp', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ index: parseInt(index), enable: isChecked })
        });
        window.loadInterfaces();
    };

    // 4. Loopback yaratish
    window.addLoopback = async () => {
        const res = await fetch('/api/interfaces/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        if (res.ok) window.loadInterfaces();
    };

    // 5. IP Modalni ochish
    window.openIpModal = (index) => {
        document.getElementById('modalIdx').value = index;
        document.getElementById('newIpAddr').value = '';
        const modal = new bootstrap.Modal(document.getElementById('ipModal'));
        modal.show();
    };

    // 6. IPni saqlash (Modal ichidagi Save tugmasi)
    window.submitIp = async () => {
        const index = document.getElementById('modalIdx').value;
        const ip = document.getElementById('newIpAddr').value;

        if (!ip.includes('/')) {
            alert("Iltimos IPni CIDR formatida kiriting (masalan: 192.168.1.1/24)");
            return;
        }

        const res = await fetch('/api/interfaces/add-ip', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ index: parseInt(index), ip: ip })
        });

        if (res.ok) {
            const modalElement = document.getElementById('ipModal');
            const modal = bootstrap.Modal.getInstance(modalElement);
            modal.hide();
            window.loadInterfaces();
        } else {
            alert("IP qo'shishda xato yuz berdi");
        }
    };

    // IPni o'chirish funksiyasi
    window.removeIp = async (index, ip) => {
        if (!confirm(`${ip} manzilini interfeysdan o'chirmoqchimisiz?`)) return;

        try {
            const res = await fetch('/api/interfaces/remove-ip', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    index: parseInt(index),
                    ip: ip
                })
            });

            if (res.ok) {
                window.loadInterfaces(); // Ro'yxatni yangilash
            } else {
                const err = await res.json();
                alert("Xato: " + (err.error || "IPni o'chirib bo'lmadi"));
            }
        } catch (e) {
            console.error("IP remove error:", e);
            alert("Server bilan ulanishda xato!");
        }
    };
    // 7. Interfeysni o'chirish
    window.deleteInterface = async (index) => {
        if (!confirm("Haqiqatan ham bu interfeysni o'chirmoqchimisiz?")) return;

        const res = await fetch('/api/interfaces/delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ index: parseInt(index) })
        });

        if (res.ok) {
            window.loadInterfaces();
        } else {
            alert("Xato: Faqat virtual interfeyslarni (Loopback) o'chirish mumkin.");
        }
    };

    document.addEventListener('DOMContentLoaded', window.loadInterfaces);
</script>
{{ end }}