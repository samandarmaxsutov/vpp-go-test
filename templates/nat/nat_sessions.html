{{ define "nat_sessions" }}
<div class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
        <h6 class="fw-bold mb-0 text-success">
            <i class="bi bi-people-fill me-2"></i>Foydalanuvchilar Trafik Statistikasi (Inside IP)
        </h6>
        <span class="badge bg-success-subtle text-success border border-success">Real-time</span>
    </div>
    <div class="table-responsive" style="max-height: 300px;">
        <table class="table table-sm table-hover align-middle mb-0">
            <thead class="table-light sticky-top">
                <tr>
                    <th>Lokal IP (User)</th>
                    <th>Sessiyalar</th>
                    <th>Paketlar</th>
                    <th>Jami Trafik</th>
                    <th style="width: 250px;">Ulush (Usage %)</th>
                </tr>
            </thead>
            <tbody id="user-traffic-body">
                <tr><td colspan="5" class="text-center py-4 text-muted">Ma'lumotlar yuklanmoqda...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<div class="card border-0 shadow-sm">
    <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
        <h6 class="fw-bold mb-0 text-primary">
            <i class="bi bi-broadcast me-2"></i>Barcha Faol NAT Sessiyalari 
            <span id="sessionCount" class="badge bg-secondary ms-2">0</span>
        </h6>
        <div class="d-flex gap-2">
            <div class="input-group input-group-sm" style="width: 250px;">
                <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
                <input type="text" id="sessionSearch" class="form-control" placeholder="IP bo'yicha qidirish..." onkeyup="filterSessions()">
            </div>
            <button class="btn btn-sm btn-primary" onclick="loadActiveSessions()">
                <i class="bi bi-arrow-clockwise me-1"></i> Yangilash
            </button>
        </div>
    </div>
    <div class="table-responsive" style="max-height: 60vh;">
        <table class="table table-hover align-middle mb-0" id="sessionTable">
            <thead class="table-light sticky-top">
                <tr>
                    <th>Proto</th>
                    <th>Inside (Local)</th>
                    <th>Outside (NAT)</th>
                    <th>External Host</th>
                    <th>Trafik</th>
                    <th>Status</th>
                    <th class="text-end">Amallar</th>
                </tr>
            </thead>
            <tbody id="session-table-body">
                <tr><td colspan="7" class="text-center py-5 text-muted">Sessiyalarni yuklash uchun "Yangilash" tugmasini bosing</td></tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    let allSessions = [];

    // Ma'lumotlarni API'dan yuklash
    async function loadActiveSessions() {
        const tbody = document.getElementById('session-table-body');
        const ubody = document.getElementById('user-traffic-body');
        
        tbody.innerHTML = '<tr><td colspan="7" class="text-center py-5"><div class="spinner-border spinner-border-sm text-primary me-2"></div>Yuklanmoqda...</td></tr>';
        
        try {
            const res = await fetch('/api/nat/sessions');
            allSessions = await res.json() || [];
            renderEverything(allSessions);
        } catch (e) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center py-5 text-danger">Xatolik yuz berdi</td></tr>';
        }
    }

    // Har ikkala jadvalni chizish
    function renderEverything(sessions) {
        renderSessionsTable(sessions);
        renderUserTrafficTable(sessions);
    }

    // 1-Jadval: Sessiyalar ro'yxati
    function renderSessionsTable(sessions) {
        const tbody = document.getElementById('session-table-body');
        document.getElementById('sessionCount').innerText = sessions.length;
        tbody.innerHTML = '';

        if (sessions.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center py-5 text-muted">Faol sessiyalar topilmadi</td></tr>';
            return;
        }

        sessions.forEach(s => {
            const proto = s.protocol === 6 ? 'TCP' : (s.protocol === 17 ? 'UDP' : (s.protocol === 1 ? 'ICMP' : s.protocol));
            const statusClass = s.is_timed_out ? 'bg-warning-subtle text-warning border-warning' : 'bg-success-subtle text-success border-success';
            
            tbody.innerHTML += `
                <tr class="${s.is_timed_out ? 'opacity-75' : ''}">
                    <td><span class="badge border bg-light text-dark">${proto}</span></td>
                    <td>
                        <div class="small fw-bold">${s.inside_ip_address}</div>
                        <div class="text-muted small">Port: ${s.inside_port}</div>
                    </td>
                    <td>
                        <div class="small fw-bold text-info">${s.outside_ip_address}</div>
                        <div class="text-muted small">Port: ${s.outside_port}</div>
                    </td>
                    <td>
                        <div class="small fw-bold text-primary">${s.ext_host_address}</div>
                        <div class="text-muted small">Port: ${s.ext_host_port}</div>
                    </td>
                    <td>
                        <div class="small fw-bold">${(s.total_bytes / 1024).toFixed(2)} KB</div>
                        <div class="text-muted small">${s.total_pkts} pkts</div>
                    </td>
                    <td><span class="badge border ${statusClass}">${s.is_timed_out ? 'Timed Out' : 'Active'}</span></td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-outline-danger border-0" onclick='killSpecificSession(${JSON.stringify(s)})'>
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>`;
        });
    }

    // 2-Jadval: User Traffic Summary
    function renderUserTrafficTable(sessions) {
        const utBody = document.getElementById('user-traffic-body');
        const userTraffic = calculateTrafficByUser(sessions);
        utBody.innerHTML = '';

        const grandTotalBytes = Object.values(userTraffic).reduce((sum, u) => sum + u.totalBytes, 0);
        const sortedIPs = Object.keys(userTraffic).sort((a, b) => userTraffic[b].totalBytes - userTraffic[a].totalBytes);

        if (sortedIPs.length === 0) {
            utBody.innerHTML = '<tr><td colspan="5" class="text-center py-3">Ma\'lumot yo\'q</td></tr>';
            return;
        }

        sortedIPs.forEach(ip => {
            const data = userTraffic[ip];
            const mb = (data.totalBytes / (1024 * 1024)).toFixed(2);
            const kb = (data.totalBytes / 1024).toFixed(2);
            const percentage = grandTotalBytes > 0 ? ((data.totalBytes / grandTotalBytes) * 100).toFixed(1) : 0;
            const displaySize = mb > 1 ? `${mb} MB` : `${kb} KB`;

            utBody.innerHTML += `
                <tr>
                    <td><span class="fw-bold">${ip}</span></td>
                    <td><span class="badge bg-light text-dark border">${data.sessionCount} sessiya</span></td>
                    <td>${data.totalPkts.toLocaleString()}</td>
                    <td class="text-primary fw-bold">${displaySize}</td>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="progress flex-grow-1" style="height: 8px;">
                                <div class="progress-bar bg-success" style="width: ${percentage}%"></div>
                            </div>
                            <span class="ms-2 small fw-bold">${percentage}%</span>
                        </div>
                    </td>
                </tr>`;
        });
    }

    // Yordamchi: Trafikni hisoblash logikasi
    function calculateTrafficByUser(sessions) {
        const userTraffic = {};
        sessions.forEach(s => {
            const ip = s.inside_ip_address;
            const bytes = parseInt(s.total_bytes) || 0;
            const pkts = parseInt(s.total_pkts) || 0;

            if (!userTraffic[ip]) {
                userTraffic[ip] = { totalBytes: 0, totalPkts: 0, sessionCount: 0 };
            }
            userTraffic[ip].totalBytes += bytes;
            userTraffic[ip].totalPkts += pkts;
            userTraffic[ip].sessionCount += 1;
        });
        return userTraffic;
    }

    // Filtrlash funksiyasi
    function filterSessions() {
        const query = document.getElementById('sessionSearch').value.toLowerCase();
        const filtered = allSessions.filter(s => 
            s.inside_ip_address.includes(query) || 
            s.ext_host_address.includes(query)
        );
        renderEverything(filtered);
    }

    // Sessiyani o'chirish
    async function killSpecificSession(session) {
        if (!confirm("Sessiyani uzishni tasdiqlaysizmi?")) return;
        try {
            const res = await fetch('/api/nat/sessions/del', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(session)
            });
            if (res.ok) loadActiveSessions();
        } catch (e) { alert("Xatolik!"); }
    }

    // Sahifa yuklanganda avtomatik yuklash
    document.addEventListener('DOMContentLoaded', loadActiveSessions);
</script>
{{ end }}